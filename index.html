<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.67.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Pavel Derendyaev notes</title>

  
  <link type="text/css" rel="stylesheet" href="https://dddpaul.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://dddpaul.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://dddpaul.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://dddpaul.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="https://dddpaul.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="Pavel Derendyaev notes" />

  
</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Pavel Derendyaev notes</h1>
            <p class="lead">
                   
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="/blog/index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="https://dddpaul.github.io/blog//tags/android/">android</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/ansible/">ansible</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/concurrency/">concurrency</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/database/">database</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/devops/">devops</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/docker/">docker</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/git/">git</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/golang/">golang</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/hugo/">hugo</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/java/">java</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/javascript/">javascript</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/kafka/">kafka</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/linux/">linux</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/meetup/">meetup</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/python/">python</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/windows/">windows</a> </li>
            
        </ul>

        <p>&copy; 2020. All rights reserved. </p>
    </div>
</div>


<div class="content container">
    <div class="posts">

        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2019/08/10/alfabank-java-meetup-4/">
                    Backend stories 4.0 - митап в Альфа-Банке
                </a>
            </h1>

            <span class="post-date">2019-08-10</span>

            
<img src='https://dddpaul.github.io/blog//media/alfabank.jpg'/>

<p>9 августа прошел Java-митап <a href="https://hr.alfabank.ru/events/backend-stories-4-0">Backend stories 4.0</a> в Альфа-банке.</p>
<p>Презентации доступны на страничке с <a href="https://hr.alfabank.ru/blog/kak-proshel-mitap-backend-stories-4-0">отчетом о событии</a>.</p>
<p>Прямая ссылка на <a href="https://www.youtube.com/watch?v=kY4lYiqxf7k">запись трансляции</a>.</p>
<p>Мой доклад - <a href="http://dddpaul.github.io/blog/presentations/Internet-Balancing.pdf">Отказоустойчивость в большом Интернете</a></p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2019/04/01/alfabank-java-meetup-3/">
                    Backend stories 3.0 - митап в Альфа-Банке
                </a>
            </h1>

            <span class="post-date">2019-04-01</span>

            
<img src='https://dddpaul.github.io/blog//media/alfabank.jpg'/>

<p>29 марта прошел Java-митап <a href="https://hr.alfabank.ru/events/backend-stories-3-0">Backend stories 3.0</a> в Альфа-банке.</p>
<p>Материалы доступны на страничке с <a href="https://hr.alfabank.ru/blog/translyatsiya-mitapa-backend-stories-3-0">отчетом о событии</a>.</p>
<p>Прямая ссылка на <a href="https://www.youtube.com/watch?v=VvAkcjimXK0">запись трансляции</a>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2018/10/15/alfabank-java-meetup-2/">
                    Backend stories 2.0 - митап в Альфа-Банке
                </a>
            </h1>

            <span class="post-date">2018-10-15</span>

            
<img src='https://dddpaul.github.io/blog//media/alfabank.jpg'/>

<p>04 октября прошел Java-митап <a href="https://hr.alfabank.ru/events/backendstories2-0">Backend stories 2.0</a> в Альфа-банке.</p>
<p>Все материалы доступны на страничке с <a href="https://hr.alfabank.ru/blog/backend-stories">отчетом о событии</a>.</p>
<p>Прямая ссылка на <a href="https://www.youtube.com/watch?v=pojUohfDlkc">запись трансляции</a>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2018/06/23/kafka-tips/">
                    Kafka tips &amp; tricks
                </a>
            </h1>

            <span class="post-date">2018-06-23</span>

            
<img src='https://dddpaul.github.io/blog//media/apache-kafka.png'/>

<p>Список консьюмер-групп</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --list
</code></pre><p>Информация по консьюмер-группе</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --group id1 --describe
</code></pre><hr>
<p>Установка оффсета на начало</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-earliest --execute
</code></pre><p>Установка оффсета на конец</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-latest --execute
</code></pre><p>Установка оффсета на дату-время</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-datetime &quot;2017-12-22T00:00:00.000&quot; --execute
</code></pre><p>Установка оффсета на дату-время для партишенов 0, 1 (одно время для всех партишенов)</p>
<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic:0,1 --group id1 --reset-offsets --to-datetime &quot;2017-12-22T00:00:00.000&quot; --execute
</code></pre><p>Установка оффсета на дату-время для партишенов 0, 1 (разное время для партишенов)</p>
<pre><code>docker run dddpaul/kafka-rewind --servers=kafka:9092 --group-id=id1 --topic=topic -o 0=2017-12-01 -o 1=2018-01-01
</code></pre><hr>
<p>Создать топик</p>
<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-topics.sh --create --topic topic --replication-factor 1 --partitions 1 --zookeeper zookeeper:2181&quot;
</code></pre><hr>
<p>Накидать сообщений</p>
<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-verifiable-producer.sh --topic topic --max-messages 200000 --broker-list localhost:9092&quot;
</code></pre><hr>
<p>Консольный консьюмер</p>
<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-console-consumer.sh --topic topic --bootstrap-server host:9092&quot;
docker run -it wurstmeister/kafka -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-console-consumer.sh --topic topic --bootstrap-server host:9092&quot;
docker run --entrypoint=/opt/kafka/bin/kafka-console-consumer.sh wurstmeister/kafka --topic topic --bootstrap-server host:9092
</code></pre><p>Python консьюмер</p>
<pre><code>#!/usr/bin/env python
from kafka import KafkaConsumer
consumer = KafkaConsumer(bootstrap_servers='kafka1:9092',
                         group_id=None,
                         auto_offset_reset='earliest')
consumer.subscribe(['rsyslog_apps'])
for msg in consumer:
    print msg
</code></pre><p>Kafkacat консьюмер</p>
<pre><code>docker run -it confluentinc/cp-kafkacat kafkacat -b host:9092 -t topic -o beginning -v
</code></pre><hr>
<p>Установка retention на топик</p>
<pre><code>docker exec -it kafka /opt/kafka/bin/kafka-configs.sh --zookeeper host:2181 --entity-type topics --entity-name topic --describe
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --zookeeper host:2181 --topic topic --describe
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --zookeeper host:2181 --topic topic --alter --config retention.ms=1000
</code></pre>
        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2018/06/22/alfabank-java-meetup-1/">
                    Backend stories meetup в Альфа-Банке
                </a>
            </h1>

            <span class="post-date">2018-06-22</span>

            
<img src='https://dddpaul.github.io/blog///media/alfabank.jpg'/>

<p>21 июня прошел Java-митап <a href="https://hr.alfabank.ru/events/backend-stories-meetup">Backend stories</a> в Альфа-банке.</p>
<p>Доклады:</p>
<ul>
<li><a href="https://twitter.com/evgzakharov88/status/1009847790548258819">Kotlin: выходим за рамки JVM</a></li>
<li><a href="https://www.slideshare.net/MikhailFomichev1/testcontainers-oracle-inside/MikhailFomichev1/testcontainers-oracle-inside">Testcontainers: Oracle inside</a></li>
<li><a href="http://dddpaul.github.io/blog/presentations/Elasticsearch-1.pdf">Как жить, если вы неправильно готовите Elasticsearch</a></li>
</ul>
<p>Также есть <a href="https://www.youtube.com/watch?v=XT4nk89aSvY">запись трансляции</a>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/11/13/mysql-to-postgresql-migration/">
                    MySQL to PostgreSQL migration
                </a>
            </h1>

            <span class="post-date">2016-11-13</span>

            <p>Install migration Ruby gem and run it:</p>
<pre><code>gem install mysql2psql
mysql2psql
</code></pre><p>Update database credentials in generated mysql2psql.yml file:</p>
<pre><code>mysql:
  database: redmine
  hostname: localhost
  port: 3306
  username: redmine
  password: xxxxxxx
  encoding: utf8

destination:
 # if file is given, output goes to file, else postgres
 file: /tmp/redmine-pg.sql
 postgres:
  hostname: localhost
  port: 5432
  username: mysql2psql
  password:
  database: mysql2psql_test
</code></pre><p>Run command again:</p>
<pre><code>mysql2psql
</code></pre><p>Links:</p>
<ul>
<li><a href="http://www.redmine.org/boards/2/topics/12825?r=41870">How to migrate from MySQL to PostgreSQL</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/11/07/traefik-on-docker-swarm/">
                    Træfik on Docker Swarm mode cluster
                </a>
            </h1>

            <span class="post-date">2016-11-07</span>

            <p>Træfɪk is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. Since 1.1.0-rc1 it supports Docker Swarm mode as backend. It means that Træfɪk will automatically create proxying frontends which will be binded to corresponding Docker Swarm services.</p>
<p>This post is based on <a href="https://docs.traefik.io/user-guide/swarm-mode/">Docker Swarm (mode) cluster</a> example.</p>
<p>Assuming we have Docker Swarm mode cluster already, we will need to create an overlay network:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker network create --driver<span class="o">=</span>overlay traefik-net</code></pre></div>
<p>Backends are the simple <a href="https://github.com/emilevauge/whoamI">emilevauge/whoami</a> services:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker service create --name test1 --label traefik.port<span class="o">=</span><span class="m">80</span> --network traefik-net emilevauge/whoami
docker service create --name test2 --label traefik.port<span class="o">=</span><span class="m">80</span> --network traefik-net emilevauge/whoami</code></pre></div>
<p>Træfɪk itself may be ran in rich variety of configurations.</p>
<p><strong>1.</strong> HTTP only proxy</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker service create <span class="se">\
</span><span class="se"></span>--name traefik <span class="se">\
</span><span class="se"></span>--constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\
</span><span class="se"></span>--publish 80:80 --publish 8080:8080 <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/run/docker.sock,target<span class="o">=</span>/var/run/docker.sock <span class="se">\
</span><span class="se"></span>--network traefik-net <span class="se">\
</span><span class="se"></span>traefik:v1.1.0-rc3 <span class="se">\
</span><span class="se"></span>--docker <span class="se">\
</span><span class="se"></span>--docker.swarmmode <span class="se">\
</span><span class="se"></span>--docker.domain<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--docker.watch <span class="se">\
</span><span class="se"></span>--logLevel<span class="o">=</span>DEBUG <span class="se">\
</span><span class="se"></span>--web</code></pre></div>
<p>Remarks:</p>
<ul>
<li>Træfɪk web UI will we accessible on <a href="http://example.org">http://example.org</a>:8080.</li>
<li>Debug log level must be disabled on production.</li>
</ul>
<p><strong>2.</strong> HTTPS proxy with Let&rsquo;s Encrypt certificate and HTTP to HTTPS redirection</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker service create <span class="se">\
</span><span class="se"></span>--name traefik <span class="se">\
</span><span class="se"></span>--constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\
</span><span class="se"></span>--publish 80:80 --publish 443:443 --publish 8080:8080 <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/run/docker.sock,target<span class="o">=</span>/var/run/docker.sock,readonly <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/tmp,target<span class="o">=</span>/etc/traefik/acme <span class="se">\
</span><span class="se"></span>--network traefik-net <span class="se">\
</span><span class="se"></span>traefik:v1.1.0-rc3 <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:http Address::80 Redirect.EntryPoint:https&#39;</span> <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:https Address::443 TLS&#39;</span> <span class="se">\
</span><span class="se"></span>--defaultEntryPoints<span class="o">=</span>http,https <span class="se">\
</span><span class="se"></span>--acme.entryPoint<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.email<span class="o">=</span>owner@example.org <span class="se">\
</span><span class="se"></span>--acme.storage<span class="o">=</span>/etc/traefik/acme/acme.json <span class="se">\
</span><span class="se"></span>--acme.domains<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--acme.onHostRule<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>--docker <span class="se">\
</span><span class="se"></span>--docker.swarmmode <span class="se">\
</span><span class="se"></span>--docker.domain<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--docker.watch <span class="se">\
</span><span class="se"></span>--web</code></pre></div>
<p><strong>3.</strong> HTTPS-only proxy with Let&rsquo;s Encrypt certificate</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker service create <span class="se">\
</span><span class="se"></span>--name traefik <span class="se">\
</span><span class="se"></span>--constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\
</span><span class="se"></span>--publish 443:443 --publish 8080:8080 <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/run/docker.sock,target<span class="o">=</span>/var/run/docker.sock,readonly <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/tmp,target<span class="o">=</span>/etc/traefik/acme <span class="se">\
</span><span class="se"></span>--network traefik-net <span class="se">\
</span><span class="se"></span>traefik:v1.1.0-rc3 <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:https Address::443 TLS&#39;</span> <span class="se">\
</span><span class="se"></span>--defaultEntryPoints<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.entryPoint<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.email<span class="o">=</span>owner@example.org <span class="se">\
</span><span class="se"></span>--acme.storage<span class="o">=</span>/etc/traefik/acme/acme.json <span class="se">\
</span><span class="se"></span>--acme.domains<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--acme.onHostRule<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>--docker <span class="se">\
</span><span class="se"></span>--docker.swarmmode <span class="se">\
</span><span class="se"></span>--docker.domain<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--docker.watch <span class="se">\
</span><span class="se"></span>--logLevel<span class="o">=</span>DEBUG <span class="se">\
</span><span class="se"></span>--web</code></pre></div>
<p><strong>4.</strong> HTTPS-only proxy with Let&rsquo;s Encrypt certificate and HTTPS web UI</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker service create <span class="se">\
</span><span class="se"></span>--name traefik <span class="se">\
</span><span class="se"></span>--constraint<span class="o">=</span>node.role<span class="o">==</span>manager <span class="se">\
</span><span class="se"></span>--publish 443:443 --publish 8443:8443 <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/run/docker.sock,target<span class="o">=</span>/var/run/docker.sock,readonly <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/etc/pki/realms/domain,target<span class="o">=</span>/etc/traefik/tls,readonly <span class="se">\
</span><span class="se"></span>--mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/var/tmp,target<span class="o">=</span>/etc/traefik/acme <span class="se">\
</span><span class="se"></span>--network traefik-net <span class="se">\
</span><span class="se"></span>traefik:v1.1.0-rc3 <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:https Address::443 TLS:/etc/traefik/tls/default.crt,/etc/traefik/tls/default.key&#39;</span> <span class="se">\
</span><span class="se"></span>--defaultEntryPoints<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.entryPoint<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.email<span class="o">=</span>owner@example.org <span class="se">\
</span><span class="se"></span>--acme.storage<span class="o">=</span>/etc/traefik/acme/acme.json <span class="se">\
</span><span class="se"></span>--acme.domains<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--acme.onHostRule<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>--docker <span class="se">\
</span><span class="se"></span>--docker.swarmmode <span class="se">\
</span><span class="se"></span>--docker.domain<span class="o">=</span>example.org <span class="se">\
</span><span class="se"></span>--docker.watch <span class="se">\
</span><span class="se"></span>--logLevel<span class="o">=</span>DEBUG <span class="se">\
</span><span class="se"></span>--web.address<span class="o">=</span>:8443 <span class="se">\
</span><span class="se"></span>--web.certfile<span class="o">=</span>/etc/traefik/tls/default.crt <span class="se">\
</span><span class="se"></span>--web.keyfile<span class="o">=</span>/etc/traefik/tls/default.key</code></pre></div>
<p><strong>5.</strong> For debugging purposes you can run Træfɪk without Docker</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">traefik -d <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:http Address::8080 Redirect.EntryPoint:https&#39;</span> <span class="se">\
</span><span class="se"></span>--entryPoints<span class="o">=</span><span class="s1">&#39;Name:https Address::8443 TLS&#39;</span> <span class="se">\
</span><span class="se"></span>--defaultEntryPoints<span class="o">=</span>http,https <span class="se">\
</span><span class="se"></span>--acme.entryPoint<span class="o">=</span>https <span class="se">\
</span><span class="se"></span>--acme.email<span class="o">=</span>owner@example.org <span class="se">\
</span><span class="se"></span>--acme.storage<span class="o">=</span>acme.json <span class="se">\
</span><span class="se"></span>--acme.domains<span class="o">=</span>example.org
--logLevel<span class="o">=</span>DEBUG <span class="se">\
</span><span class="se"></span>--web</code></pre></div>
<p>Links:</p>
<ul>
<li><a href="https://traefik.io/">Træfɪk</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/11/02/docker-registry/">
                    Docker registry on Centos 7
                </a>
            </h1>

            <span class="post-date">2016-11-02</span>

            <p><strong>1.</strong> Create logical volumes for <code>direct-lvm</code> production mode</p>
<p>Assume that we have 40 GByte block device named as <code>/dev/sdb</code> with one full-size Linux partition on it.</p>
<p>Official <a href="https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/">Device Mapper storage driver guide</a> recommends to use <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Logical_Volume_Manager_Administration/thinprovisioned_volumes.html">thin pools</a> now. Use these commands to create thin-provisioned logical volumes:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">pvcreate /dev/sdb1                 <span class="c1"># Create physical volume</span>
vgcreate docker /dev/sdb1          <span class="c1"># Create volume group and add this physical volume to it</span>
<span class="c1"># Create logical volumes</span>
lvcreate --wipesignatures y -n data docker -l 40%VG
lvcreate --wipesignatures y -n registry docker -l 40%VG
lvcreate --wipesignatures y -n metadata docker -l 2%VG
<span class="c1"># Convert data volume to thin pool&#39;s data volume</span>
lvconvert -y --zero n -c 512K --thinpool docker/data --poolmetadata docker/metadata
<span class="c1"># Set thin pool autoextend features</span>
cat &gt; /etc/lvm/profile/docker-data.profile
activation <span class="o">{</span>
        <span class="nv">thin_pool_autoextend_threshold</span> <span class="o">=</span> <span class="m">80</span>
        <span class="nv">thin_pool_autoextend_percent</span> <span class="o">=</span> <span class="m">20</span>
<span class="o">}</span>
lvchange --metadataprofile docker-data docker/data
<span class="c1"># Check thin pool volume (must be monitored)</span> 
lvs -o+seg_monitor
  LV       VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Monitor
  root     centos -wi-ao---- 117,19g
  swap     centos -wi-ao----   1,95g
  data     docker twi-a-t---  16,00g             0,00   0,01                             monitored
  registry docker -wi-a-----  16,00g</code></pre></div>
<p>Or if you do not trust thin pools use more traditional (but deprecated in Docker) way:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">pvcreate /dev/sdb1                 <span class="c1"># Create physical volume</span>
vgcreate docker /dev/sdb1          <span class="c1"># Create volume group and add this physical volume to it</span>
lvcreate -L 2G -n metadata docker  <span class="c1"># Create logical volume for Docker metadata</span>
lvcreate -L 15G -n data docker     <span class="c1"># Create logical volume for Docker data (layers, containers etc)</span>
lvcreate -L 15G -n registry docker <span class="c1"># Create logical volume for Docker Registry data</span></code></pre></div>
<p>Mount volume for Docker registry:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">mkfs.xfs /dev/docker/registry
<span class="nb">echo</span> <span class="s2">&#34;/dev/docker/registry /var/lib/docker-registry    xfs     defaults        1 3&#34;</span> &gt;&gt; /etc/fstab 
mount -a</code></pre></div>
<p>Check:</p>
<pre><code>lsblk
NAME                             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda                                8:0    0   120G  0 disk
├─sda1                             8:1    0   876M  0 part /boot
└─sda2                             8:2    0 119,1G  0 part
  ├─centos-swap                  253:0    0     2G  0 lvm  [SWAP]
  └─centos-root                  253:1    0 117,2G  0 lvm  /
sdb                                8:16   0    40G  0 disk
└─sdb1                             8:17   0    40G  0 part
  ├─docker-metadata              253:2    0     2G  0 lvm
  │ └─docker-253:1-23762136-pool 253:5    0    15G  0 dm
  ├─docker-data                  253:3    0    15G  0 lvm
  │ └─docker-253:1-23762136-pool 253:5    0    15G  0 dm
  └─docker-registry              253:4    0    15G  0 lvm  /var/lib/docker-registry
</code></pre><p><strong>2.</strong> Configure Docker daemon</p>
<p>Create systemd drop-in file:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">mkdir -p /etc/systemd/system/docker.service.d
cat &gt; /etc/systemd/system/docker.service.d/env.conf 
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/docker
<span class="nv">ExecStart</span><span class="o">=</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd <span class="nv">$OPTIONS</span> <span class="nv">$DOCKER_NETWORK_OPTIONS</span> <span class="nv">$DOCKER_STORAGE_OPTIONS</span></code></pre></div>
<p>Specify Docker configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">cat &gt; /etc/sysconfig/docker 
<span class="nv">OPTIONS</span><span class="o">=</span><span class="s1">&#39;--iptables=false&#39;</span>
<span class="nv">DOCKER_NETWORK_OPTIONS</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nv">DOCKER_STORAGE_OPTIONS</span><span class="o">=</span><span class="s1">&#39;--storage-driver=devicemapper --storage-opt dm.datadev=/dev/docker/data --storage-opt dm.metadatadev=/dev/docker/metadata&#39;</span></code></pre></div>
<p>Check:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">systemctl daemon-reload
systemctl show docker <span class="p">|</span> grep EnvironmentFile
<span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/sysconfig/docker <span class="o">(</span><span class="nv">ignore_errors</span><span class="o">=</span>yes<span class="o">)</span></code></pre></div>
<p>And run:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">systemctl <span class="nb">enable</span> docker
systemctl restart docker</code></pre></div>
<p>Check again:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker info <span class="p">|</span> grep data
 Data file: /dev/docker/data
 Metadata file: /dev/docker/metadata
 Metadata Space Used: <span class="m">639</span> kB
 Metadata Space Total: 2.147 GB
 Metadata Space Available: 2.147 GB</code></pre></div>
<p><strong>3.</strong> Obtain SSL certificate from Let&rsquo;s Encrypt</p>
<p>It&rsquo;s can be done by different ways, see <a href="https://dddpaul.github.io/blog/2016/10/20/lego-nginx/">Let&rsquo;s Encrypt with lego and Nginx</a> for one of these.</p>
<p>Assume that certificate and key was obtained and stored in <code>/etc/pki/tls/lego/certificates</code> directory.</p>
<p><strong>4.</strong> Run Docker registry container as systemd unit</p>
<p>Create systemd unit:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">cat &gt; /etc/systemd/system/docker-registry.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Docker registry container
<span class="nv">Requires</span><span class="o">=</span>docker.service
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">ExecStartPre</span><span class="o">=</span>/usr/bin/docker create -p 5000:5000 -v /var/lib/docker-registry:/var/lib/registry -v /etc/pki/tls/lego/certificates:/certs -e <span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/example.org.crt -e <span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/example.org.key --name registry registry:2
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker start -a registry
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop -t <span class="m">5</span> registry
<span class="nv">ExecStopPost</span><span class="o">=</span>/usr/bin/docker rm registry

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target</code></pre></div>
<p><strong>5.</strong> Permit access to Docker registry only from trusted networks</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">firewall-cmd --zone<span class="o">=</span>trusted --add-port<span class="o">=</span>5000/tcp --permanent
firewall-cmd --zone<span class="o">=</span>trusted --add-source<span class="o">=</span>192.168.1.0/24 --permanent
firewall-cmd --reload</code></pre></div>
<p>Since Docker daemon was launched with <code>--iptables=false</code> option, Docker registry port may be accessed from trusted networks only.</p>
<p>Links:</p>
<ul>
<li><a href="https://docs.docker.com/engine/admin/systemd/">Control and configure Docker with systemd</a></li>
<li><a href="https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/">Docker and the Device Mapper storage driver</a></li>
<li><a href="http://trainingdevops.com/insights-and-tutorials/deploying-docker-registry-with-let-s-encrypt-ssl-tls-certs">Deploying Docker Registry with Let&rsquo;s Encrypt SSL/TLS Certs</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/10/20/lego-nginx/">
                    Let&#39;s Encrypt with lego and Nginx
                </a>
            </h1>

            <span class="post-date">2016-10-20</span>

            <p><a href="https://github.com/xenolf/lego">xenolf/lego</a> it&rsquo;s a feature-rich Let&rsquo;s Encrypt client and ACME library written in Go.</p>
<p><strong>1.</strong> Prepare Nginx server</p>
<pre><code>server {
    listen 80 default;
    server_name example.org www.example.org;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:81;
        proxy_set_header Host $host;
    }

    # Other directives
}
</code></pre><p><strong>2.</strong> Update ca-certificates for CentOS 5 (optional)</p>
<p>Let&rsquo;s Encrypt CA certificate is not included into root CA bundle of old Linux distributions like RHEL/Centos 5. You have to replace this bundle manually with fresh one from <a href="http://curl.haxx.se/">cURL website</a>:</p>
<pre><code>cp /etc/pki/tls/certs/ca-bundle.crt /etc/pki/tls/certs/ca-bundle.crt.bak
wget -O /etc/pki/tls/certs/ca-bundle.crt http://curl.haxx.se/ca/cacert.pem
</code></pre><p><strong>3.</strong> Order the certificate from Let&rsquo;s Encrypt</p>
<pre><code>lego -d example.org -d www.example.org -m cert-owner@example.org -a --path=/etc/pki/tls/lego --http=:81 run
</code></pre><p><strong>4.</strong> Update Nginx server</p>
<pre><code>server {
    listen 80 default;
    server_name example.org www.example.org;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:81;
        proxy_set_header Host $host;
    }

    # Other directives
}

server {
    listen 443 ssl;
    server_name example.org www.example.org;

    ssl_certificate /etc/pki/tls/lego/certificates/example.org.crt;
    ssl_certificate_key /etc/pki/tls/lego/certificates/example.org.key;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:444;
        proxy_set_header Host $host;
    }

    # Other directives
}

</code></pre><p><strong>5.</strong> Renew certificate every 2 month at 01:30 of first day of the month</p>
<p>Add to crontab:</p>
<pre><code>30 01 01 */2 * /usr/local/bin/lego -d example.org -d www.example.org -m cert-owner@example.org -a --path=/etc/pki/tls/lego --http=:81 --tls=:444 renew &amp;&amp; /usr/sbin/nginx -s reload
</code></pre><p>Links:</p>
<ul>
<li><a href="https://github.com/xenolf/lego">Let&rsquo;s Encrypt client and ACME library written in Go</a></li>
<li><a href="https://code.kuederle.com/letsencrypt/">LET’S ENCRYPT WITH LEGO AND NGINX</a></li>
<li><a href="https://raymii.org/s/snippets/CentOS_5_CA_Certificate_Bundle_Update.html">CentOS 5 CA Certificate Bundle Update</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/09/07/windows-backup/">
                    Выбор простого бэкапа для Windows
                </a>
            </h1>

            <span class="post-date">2016-09-07</span>

            <p>Доступные и функциональные системы бэкапа под Windows.</p>
<p>Требования:</p>
<ul>
<li>Основное - использование жестких или символьных ссылок для дедупликации содержимого архива.</li>
<li>Дополнительное - использование VSS (Volume Shadow Copy Service) для предварительного создания снэпшота.</li>
</ul>
<p>Не рассматриваются сложные распределенные (и дорогие) системы бэкапа. Один компьютер, одна программа или скрипт.</p>
<h3 id="dublicatihttpwwwduplicaticom"><a href="http://www.duplicati.com/">Dublicati</a></h3>
<p>Duplicati is a free backup client that securely stores encrypted, incremental, compressed backups on cloud storage services and remote file servers. It works with Amazon S3, Windows Live SkyDrive, Google Drive (Google Docs), Rackspace Cloud Files or WebDAV, SSH, FTP (and many more).</p>
<p>Рассматривалась версия 1.3.4.</p>
<p>Особенности:</p>
<ul>
<li>архив - zip-файл.</li>
</ul>
<p>Преимущества:</p>
<ul>
<li>бесплатность;</li>
<li>кроссплатформенность (требуются .NET 2.0+ или Mono);</li>
<li>полные и инкрементальные бэкапы;</li>
<li>есть возможность шифрования архивов;</li>
<li>используется VSS;</li>
<li>есть русский язык;</li>
<li>есть мастер восстановления.</li>
</ul>
<p>Недостатки:</p>
<ul>
<li>корявый интерфейс;</li>
<li>файловые ссылки не используются;</li>
<li>наглядность при просмотре архивов отсутствует;</li>
<li>субъективно низкая скорость работы.</li>
</ul>
<h3 id="cobian-backuphttpwwwcobiansoftcom"><a href="http://www.cobiansoft.com/">Cobian Backup</a></h3>
<p>Рассматривалась версия 11.</p>
<p>Особенности:</p>
<ul>
<li>архив - каталог.</li>
</ul>
<p>Преимущества:</p>
<ul>
<li>отличный интерфейс;</li>
<li>бесплатность;</li>
<li>полные, инкрементальные и дифференциальные бэкапы;</li>
<li>есть возможность шифрования файлов в архиве (каждый файл пакуется в зашифрованный архив);</li>
<li>субъективно высокая скорость работы.</li>
<li>есть русский язык;</li>
<li>используется VSS.</li>
</ul>
<p>Недостатки:</p>
<ul>
<li>файловые ссылки не используются;</li>
<li>вообще, отличная программа, но отсутствие программы восстановления сводит все преимущества на нет - не руками же восстанавливать файлы из инкрементальных (разностных) архивов.</li>
</ul>
<h3 id="hardlink-backuphttpwwwlupinhonethardlinkbackup"><a href="http://www.lupinho.net/hardlinkbackup/">Hardlink Backup</a></h3>
<p>Рассматривалась версия 2.1.1.</p>
<p>Особенности:</p>
<ul>
<li>архив - каталог.</li>
</ul>
<p>Идеальная программа - подходит и под основное, и под дополнительное требования.</p>
<p>Преимущества:</p>
<ul>
<li>отличный интерфейс;</li>
<li>используется VSS;</li>
<li>используются файловые ссылки;</li>
<li>наглядный просмотр архивов (из Проводника или программы);</li>
<li>субъективно высокая скорость работы;</li>
<li>есть возможность восстановления из программы.</li>
</ul>
<p>Недостатки:</p>
<ul>
<li>нет русского языка;</li>
<li>самый главный минус - в бесплатной версии отсутствует запуск процесса бэкапа по расписанию.</li>
<li>платная версия стоит 29 евро.</li>
</ul>
<h3 id="скрипт-roboshothttproboshotsourceforgenet"><a href="http://roboshot.sourceforge.net/">Скрипт RoboShot</a></h3>
<p>Рассматривалась версия 0.3.</p>
<p>Особенности:</p>
<ul>
<li>написан на PowerShell;</li>
<li>для копирования использует robocopy (т.е. высокая скорость работы);</li>
<li>вроде использует VSS;</li>
<li>использует файловые ссылки.</li>
</ul>
<p>Недостатки:</p>
<ul>
<li>требует доработки напильником (например, надо править регекспы с немецкой локализации Windows на русской);</li>
<li>на мой взгляд, слишком большой объем кода.</li>
</ul>
<h3 id="комбайн-из-bat-скрипта-rsync-и-vssadminhttpblogjay2k1com20110813how-to-create-rsync-like-hard-link-backups-with-vss-on-windows"><a href="http://blog.jay2k1.com/2011/08/13/how-to-create-rsync-like-hard-link-backups-with-vss-on-windows/">Комбайн из bat-скрипта, rsync и vssadmin</a></h3>
<p>Недостатки:</p>
<ul>
<li>требует доработки напильником;</li>
<li>для rsync требуется cygwin, что субъективно дает просадку по скорости.</li>
</ul>
<h3 id="утилита-ln-и-скрипт-deloreancopyhttpschinaglprivatntlnlnhtml"><a href="http://schinagl.priv.at/nt/ln/ln.html">Утилита LN и скрипт DeloreanCopy</a></h3>
<p>На мой взгляд, самое простое и лучшее решение, если не нужен VSS из коробки.</p>
<ul>
<li><a href="http://schinagl.priv.at/nt/hardlinkshellext/hardlinkshellext.html">Link Shell Extension</a></li>
<li><a href="http://schinagl.priv.at/nt/ln/ln.html">ln</a> - command line hardlinks</li>
</ul>
<p>DeLoreanCopy.bat требует 3 ясных параметра:</p>
<pre><code>Usage: DeLoreanCopy &lt;SourcePath&gt; &lt;DestPath&gt; (&lt;KeepMaxCopies&gt;)
SourcePath directory containing the files to be backed up
DestPath directory where &quot;DeLorean copy&quot; sets will be created
KeepMaxCopies (opt.) remove any exceeding number of DLC sets before copying
e.g. DeLoreanCopy c:\data\source c:\data\backup 90
</code></pre><p>Преимущества:</p>
<ul>
<li>простота;</li>
<li>бесплатность;</li>
<li>используются файловые ссылки;</li>
<li>очень просто прикручивается VSS.</li>
</ul>
<p>Создание снэпшота с помощью <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb530725(v=vs.85).aspx">vshadow</a> и запуск скрипта vss-exec-delorean.cmd:</p>
<pre><code>vshadow.exe -script=vss-setvar.cmd -exec=vss-exec-delorean.cmd c:
</code></pre><p>Скрипт vss-exec-delorean.cmd:</p>
<pre><code>REM
REM called from vshadow via commandline e.g
REM
REM vshadow.exe -script=vss-setvar.cmd -exec=vss-exec.cmd e:
REM
REM vss-setvar.cmd is generated by vshadow.exe
REM
call vss-setvar.cmd
REM assign a DOS device to the created snapshot
REM
dosdev x: %shadow_device_1%
REM run the intended copy job
REM
DeLoreanCopy.bat X:\Users\paul\Documents C:\backup\ 3
REM finally remove the drive letter
REM
dosdev -r -d x:
</code></pre>
        </div>
        
    </div>


<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter34067830 = new Ya.Metrika({
                    id:34067830,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/34067830" style="position:absolute; left:-9999px;" alt="" /></div></noscript>



</body>
</html>
