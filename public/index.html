<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Dev notes &middot; Dev notes </title>

  
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/poole.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/syntax.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/hyde.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://dddpaul.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="Dev notes" />

</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Dev notes</h1>
            <p class="lead">
                 Notes about Android, Java, JavaScript, Go and other technical stuff 
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="http://google.com/&#43;PavelDerendyaev1"> Google&#43; </a></li>
            
            <li><a href="index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="http://dddpaul.github.io/blog/tags/android">android</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/angularjs">angularjs</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/devops">devops</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/docker">docker</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/git">git</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/golang">golang</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/hugo">hugo</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/java">java</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/javascript">javascript</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog/tags/linux">linux</a> </li>
            
        </ul>

        <p>&copy; 2015. All rights reserved. </p>
    </div>
</div>


<div class="content container">
    <div class="posts">

        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/17/memory-leaks-articles/">
                    List of memory leaks articles
                </a>
            </h1>

            <span class="post-date">2015-01-17</span>

            <p>&ldquo;Solving OutOfMemoryError&rdquo; series from Nikita Salnikov-Tarnovsky:</p>

<ul>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-story-of-a-developer">Solving OutOfMemoryError (part 1) – story of a developer</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-why-didnt-operations-solve-it">Solving OutOfMemoryError (part 2) - why didn’t operations solve it?</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-where-do-you-start">Solving OutOfMemoryError (part 3) – where do you start?</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-memory-profilers">Solving OutOfMemoryError (part 4) – memory profilers</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-jdk-tools">Solving OutOfMemoryError (part 5) – JDK Tools</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-dump-is-not-a-waste">Solving OutOfMemoryError (part 6) – Dump is not a waste</a></li>
</ul>

<p>&ldquo;Classloader leaks&rdquo; series from Mattias Jiderhamn:</p>

<ul>
<li><a href="http://java.jiderhamn.se/2011/12/11/classloader-leaks-i-how-to-find-classloader-leaks-with-eclipse-memory-analyser-mat/">Classloader leaks I – How to find classloader leaks with Eclipse Memory Analyser (MAT)</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/01/classloader-leaks-ii-find-and-work-around-unwanted-references/">Classloader leaks II – Find and work around unwanted references</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/15/classloader-leaks-iii-die-thread-die/">Classloader leaks III – “Die Thread, die!”</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/29/classloader-leaks-iv-threadlocal-dangers-and-why-threadglobal-may-have-been-a-more-appropriate-name/">Classloader leaks IV – ThreadLocal dangers and why ThreadGlobal may have been a more appropriate name</a></li>
<li><a href="http://java.jiderhamn.se/2012/02/26/classloader-leaks-v-common-mistakes-and-known-offenders/">Classloader leaks V – Common mistakes and Known offenders</a></li>
<li><a href="http://java.jiderhamn.se/2012/03/04/classloader-leaks-vi-this-means-war-leak-prevention-library/">Classloader leaks VI – “This means war!” (leak prevention library)</a></li>
</ul>

<p>Tomcat specific articles:</p>

<ul>
<li><a href="http://java.dzone.com/articles/memory-leak-protection-tomcat">Memory Leak Protection in Tomcat 7</a></li>
<li><a href="http://wiki.apache.org/tomcat/MemoryLeakProtection">Tomcat Wiki - MemoryLeakProtection</a></li>
</ul>

<p>Other articles:</p>

<ul>
<li><a href="https://plumbr.eu/blog/what-is-a-memory-leak">What is a memory leak?</a></li>
<li><a href="https://plumbr.eu/blog/what-is-a-permgen-leak">What is a PermGen leak?</a></li>
<li><a href="https://plumbr.eu/permgen">The Guide to Solving Permgen Leaks</a></li>
<li><a href="http://frankkieviet.blogspot.se/2006/10/classloader-leaks-dreaded-permgen-space.html">Classloader leaks: the dreaded &ldquo;java.lang.OutOfMemoryError: PermGen space&rdquo; exception</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/12/docker-fig/">
                    Запуск контейнеров с помощью Fig
                </a>
            </h1>

            <span class="post-date">2015-01-12</span>

            

<p>Это третья статья цикла 
<a href='http://dddpaul.github.io/blog/series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>Как мы уже убедились, запуск контейнеров с помощью <code>docker run</code> — занятие весьма муторное, т.к. необходимо указывать множество опций. При запуске же нескольких контейнеров ситуация только ухудшается, т.к. теперь нужно задавать имена и линки.</p>

<p>Эту проблему решает инструмент <a href="http://www.fig.sh/">Fig</a>, который может запустить/остановить целое тестовое окружение, состоящее из набора контейнеров. Описание контейнеров задано в YAML-файле. Таким образом, этот YAML-файл представляет собой конфигурацию тестового окружения.</p>

<p>Конфигурация нашего тестового окружения <em>test-env/fig.yml</em>:</p>

<pre><code>app1:
  image: smile/app1
  ports: ['2021:22', '8081:80']
  privileged: true

app2:
  image: smile/app2
  ports: ['2022:22', '8082:80']
  privileged: true

gate:
  image: smile/gate
  links: [app1, app2]
  ports: ['2020:22', '80:80']
  privileged: true
</code></pre>

<p>Запуск тестового окружения (находясь в каталоге с файлом <em>fig.yml</em>): <code>fig up</code>.</p>

<p>По-умолчанию, Fig захватывает консоль и мультиплексирует вывод всех контейнеров. Для запуска в detached mode нужно использовать опцию <code>-d</code>. Посмотреть вывод контейнеров в этом режиме можно с помощью команды <code>fig logs</code>.</p>

<p>Статус тестового окружения: <code>fig ps</code>.</p>

<p>Остановка тестового окружения: <code>fig stop</code>.</p>

<h3 id="запуск-тестового-окружения-с-помощью-upstart:d4c1615d910942891ab8ffffd8a5f2e3">Запуск тестового окружения с помощью Upstart</h3>

<p>Job <em>/etc/init/fig-test-env.conf</em> создан на основе <a href="https://gist.github.com/HeyImAlex/9649374">HeyImAlex/fig.conf</a>. Для отключения автостарта нужно закомментировать вторую строчку (&ldquo;start on &hellip;&rdquo;).</p>

<pre><code>description &quot;Test environment runner&quot;
start on filesystem and started docker
stop on runlevel [!2345]
respawn
chdir /path/to/test-env
script
  # Wait for docker to finish starting up first.
  FILE=/var/run/docker.sock
  while [ ! -e $FILE ] ; do
    inotifywait -t 2 -e create $(dirname $FILE)
  done
  /usr/local/bin/fig up
end script
post-stop script
 /usr/local/bin/fig stop
end script
</code></pre>

<p>Теперь можно запустить тестовое окружение из любого места командой <code>start fig-test-env</code>, а остановить — <code>stop fig-test-env</code>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/08/docker-linking/">
                    Связывание контейнеров
                </a>
            </h1>

            <span class="post-date">2015-01-08</span>

            <p>Это вторая статья цикла 
<a href='http://dddpaul.github.io/blog/series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>При создании тестовых окружений из нескольких контейнеров неизбежно возникает задача их взаимного связывания. Набивший оскомину пример: контейнеру с приложением нужен контейнер БД. В нашем же случае, контейнеру с балансером нужны контейнеры с апстримами.</p>

<p>Статья <a href="https://docs.docker.com/userguide/dockerlinks/">Linking Containers Together</a> полностью раскрывает вопрос линковки контейнеров. Осветим вкратце лишь основные моменты:</p>

<ul>
<li>каждый контейнер необходимо как-то назвать с помощью опции <code>--name</code>;</li>
<li>ссылка на контейнер-зависимость обозначается опцией <code>--link</code>;</li>
<li>в итоге, внутри зависимого контейнера, инициализируется множество переменных окружения, содержащих параметры контейнера-зависимости, а также в <em>/etc/hosts</em> заносится IP-адрес контейнера-зависимости.</li>
</ul>

<p>Например, так выглядит последовательный запуск 3-х контейнеров, причем 3-й зависит от первых двух:</p>

<pre><code>docker run -d --privileged -p 2021:22 -p 8081:80 --name app1 smile/tomcat7
docker run -d --privileged -p 2022:22 -p 8082:80 --name app2 smile/tomcat7
docker run -d --privileged -p 2020:22 -p 80:80 --name gate --link app1:app1 --link app2:app2 smile/gate
</code></pre>

<p>Для проверки можно использовать вывод <code>docker inspect</code>:</p>

<pre><code>docker inspect -f &quot;{{ .HostConfig.Links }}&quot; gate

[/app1:/gate/app1 /app2:/gate/app2]
</code></pre>

<p>Опция <code>-d (detach mode)</code> здесь необходима, чтобы контейнеры запускались в фоновом режиме и не захватывали консоль.</p>

<p>Теперь, если зайти в контейнер gate (<code>ssh -p 2020 root@localhost</code>) и посмотреть переменные окружения, то будет ясно, что gate &ldquo;видит&rdquo; exposed-порты и IP-адрес контейнера-зависимости:</p>

<pre><code>root@aba982937531:~# env | grep APP1
APP1_NAME=/gate/app1
APP1_PORT_22_TCP=tcp://172.17.0.28:22
APP1_PORT_80_TCP=tcp://172.17.0.28:80
APP1_PORT_22_TCP_ADDR=172.17.0.28
APP1_PORT_80_TCP_ADDR=172.17.0.28
APP1_PORT_22_TCP_PORT=22
APP1_PORT_80_TCP_PORT=80
APP1_PORT_80_TCP_PROTO=tcp
APP1_PORT_22_TCP_PROTO=tcp
APP1_PORT=tcp://172.17.0.28:22
...
</code></pre>

<p>Еще лучше дела обстоят с <em>/etc/hosts</em>:</p>

<pre><code>root@aba982937531:~# grep app1 /etc/hosts
172.17.0.28	app1

</code></pre>

<p>Модификация <em>/etc/hosts</em>, например, дает возможность писать следующие кофиги Nginx:</p>

<pre><code>server {
    listen 80 default_server;
    server_name _;

    location /app1 {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #
        proxy_pass http://app1:80/app1;                              # app1 host here
        proxy_redirect http://127.0.0.1:8081/app1 /app1;             #
    }

    location /app2 {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #
        proxy_pass http://app2:80/app2;                              # and app2 host here
        proxy_redirect http://127.0.0.1:8082/app2 /app2;             #
    }
}
</code></pre>

<p>Таким образом, в первом приближении, встроенная возможность связывания контейнеров в Docker решает наши проблемы.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/04/docker-prepare/">
                    Подготовка и запуск docker-контейнеров
                </a>
            </h1>

            <span class="post-date">2015-01-04</span>

            

<p>Это первая статья цикла 
<a href='http://dddpaul.github.io/blog/series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>Сразу оговорюсь, что все docker-контейнеры основаны на <a href="http://phusion.github.io/baseimage-docker/">baseimage-docker</a>. Этот образ позволяет запускать в контейнере несколько приложений с помощью супервизора <a href="http://smarden.org/runit/">runit</a> и содержит ssh, cron, syslog &ldquo;из коробки&rdquo;.</p>

<p>Хотя подобный подход <a href="http://jpetazzo.github.io/2014/06/23/docker-ssh-considered-evil/">не рекомендуется разработчиками Docker</a>, он очень удобен в эксплуатации и не принуждает разработчика к своему &ldquo;proper way&rdquo;. Всегда можно использовать канонический подход от Docker с volumes и nsenter, а, при желании, подключаться к контейнерам по ssh.</p>

<p>Кроме того, я привык использовать сервера приложений в связке с nginx, и baseimage-docker позволяет легко это сделать.</p>

<h3 id="базовый-образ:4df06129fe4804053dfd65ac4e205d9e">Базовый образ</h3>

<p>При создании базового образа выполняются две вещи:</p>

<ul>
<li>публичный ssh-ключ добавляется в список разрешенных для суперпользователя контейнера;</li>
<li>задается локаль.</li>
</ul>

<p><em>Dockerfile</em> базового образа:</p>

<pre><code>FROM phusion/baseimage:0.9.15

# Add public SSH keys
ADD my_rsa_public_key /tmp/my_rsa_public_key
RUN cat /tmp/my_rsa_public_key &gt;&gt; /root/.ssh/authorized_keys &amp;&amp; rm -f /tmp/my_rsa_public_key

# Locale
ENV LANG=en_US.utf8

# Use baseimage-docker's init system
CMD [&quot;/sbin/my_init&quot;]
</code></pre>

<p>Свой публичный ssh-ключ, естественно, надо положить в <em>my_rsa_public_key</em> рядом с <em>Dockerfile</em>.</p>

<p>Сборка: <code>docker build -t smile/base .</code> и запуск:</p>

<pre><code>docker run --rm -it -p 2022:22 smile/base /sbin/my_init -- bash -l
</code></pre>

<p><code>--rm</code> используется для удаления контейнера после его остановки, <code>-it</code> — для терминального интеракивного режима, а <code>-- bash -l</code> — для запуска шелла после запуска всех сервисов.</p>

<p>Также на контейнер можно зайти по ssh: <code>ssh -p 2022 root@localhost</code>.</p>

<h3 id="образ-с-nginx:4df06129fe4804053dfd65ac4e205d9e">Образ с nginx</h3>

<p>Сборка <a href="https://github.com/dddpaul/docker-nginx">docker-nginx</a>: <code>docker build -t smile/nginx .</code></p>

<p>Основная особенность этого образа в том, что при запуске контейнера отключается IPv6.</p>

<p>Сделано это для того, чтобы обойти известную проблему с проксированием Nginx. Т.к. демон висит на tcp6, то апстрим иногда видит запрос от 127.0.0.1, а иногда от 0:0:0:0:0:0:0:1. Это принуждает к изменению ACL на сервере приложений, что не всегда удобно.</p>

<p>IPv6 отключается после выполнения серии sysctl-команд, которые требуют, чтобы контейнер был запущен в привилегированном режиме, т.е. команда запуска слегка усложняется:</p>

<pre><code>docker run --privileged --rm -it -p 2022:22 smile/nginx /sbin/my_init -- bash -l
</code></pre>

<h3 id="остальные-образы:4df06129fe4804053dfd65ac4e205d9e">Остальные образы</h3>

<p>На основе docker-nginx можно строить более сложные образы, такие как <a href="https://github.com/dddpaul/docker-java7-server">docker-java7-server</a> и  <a href="https://github.com/dddpaul/docker-tomcat7">docker-tomcat7</a>. На основе последнего уже строятся образы для конечных приложений.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/12/21/method-handle-logger/">
                    Using method handles to get logger
                </a>
            </h1>

            <span class="post-date">2014-12-21</span>

            <p>One more quote from <a href="http://www.manning.com/evans/">The Well-Grounded Java Developer</a> by Benjamin J. Evans and Martijn Verburg about useful feature of <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/invoke/MethodHandle.html">MethodHandle</a>.</p>

<hr />

<p>One additional feature that method handles provide is the ability to determine the current class from a static context. If you’ve ever written logging code (such as for log4j) that looked like this,</p>

<pre><code>Logger lgr = LoggerFactory.getLogger(MyClass.class);
</code></pre>

<p>you know that this code is fragile. If it’s refactored to move into a superclass or subclass, the explicit class name would cause problems With Java 7, however, you can write this:</p>

<pre><code>Logger lgr = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());
</code></pre>

<hr />

<p>It&rsquo;s really works :)</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/12/06/jmm-1/">
                    Java Memory Model in few words
                </a>
            </h1>

            <span class="post-date">2014-12-06</span>

            <p>This article is mostly consist of quotes from <a href="http://www.manning.com/evans/">The Well-Grounded Java Developer</a> by Benjamin J. Evans and Martijn Verburg. I like simplicity and brevity of their explanation approach.</p>

<p>And that&rsquo;s how <em>Happens-Before</em> and <em>Synchronizes-With</em> relationships are explained.</p>

<hr />

<ul>
<li>Happens-Before — This relationship indicates that one block of code fully completes before the other can start.</li>
<li>Synchronizes-With — This means that an action will synchronize its view of an object with main memory before continuing.</li>
</ul>

<p>The JMM has these main rules:</p>

<ul>
<li>An unlock operation on a monitor <em>Synchronizes-With</em> later lock operations.</li>
<li>A write to a volatile variable <em>Synchronizes-With</em> later reads of the variable.</li>
<li>If an action A <em>Synchronizes-With</em> action B, then A <em>Happens-Before</em> B.</li>
<li>If A comes before B in program order, within a thread, then A <em>Happens-Before</em> B.</li>
</ul>

<p>The general statement of the first two rules is that <em>&ldquo;releases happen before acquires&rdquo;</em>. In other words, the locks that a thread holds when writing are released before the locks can be acquired by other operations (including reads).</p>

<p>There are additional rules, which are really about sensible behavior:</p>

<ul>
<li>The completion of a constructor <em>Happens-Before</em> the finalizer for that object starts to run (an object has to be fully constructed before it can be finalized).</li>
<li>An action that starts a thread <em>Synchronizes-With</em> the first action of the new thread.</li>
<li>Thread.join() <em>Synchronizes-With</em> the last (and all other) actions in the thread being joined.</li>
<li>If X <em>Happens-Before</em> Y and Y <em>Happens-Before</em> Z then X <em>Happens-Before</em> Z (transitivity).</li>
</ul>

<hr />

<p>They even have granted free access to entire <a href="http://www.manning.com/evans/TWGJD_sample_ch04.pdf">Chapter 4. Modern concurrency</a>. Although I&rsquo;m not relish with the code style (using trailing underscore to emphasize method parameters - why?) this chapter definitely deserves to read it.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/11/14/motion-remote-control/">
                    Дистанционное управление Motion с помощью Go
                </a>
            </h1>

            <span class="post-date">2014-11-14</span>

            <p>Цель — сделать удобное управление для сервачка с системой motion detection.  В качестве сервера пригодился классический нетбук Asus Eee PC 701 4-х гигабайтным SSD на борту. На него была установлена Ubuntu 14.04.</p>

<p>Задачи:</p>

<ol>
<li>Собственно, motion detection (для этого был использован <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome">Motion</a>).</li>
<li>Управление настройками Motion через ИК-пульт.</li>
<li>Вывод всех сообщений от Motion и сигналов от пульта на консоль (<em>/dev/tty1</em>).</li>
<li>Минимальное время работы экрана (быстрый переход в энергосберегающйй режим, просыпание по сигналу от пульта).</li>
</ol>

<p><strong>1.</strong> Motion ставится элементарно — <code>apt-get install motion</code>. Важные настройки:</p>

<p><div class="highlight"><pre>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;максимальный-fps:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Максимальный fps&lt;/h1&gt;

&lt;p&gt;framerate 5&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;снимать-на-максимальном-fps-только-во-время-движения:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Снимать на максимальном fps только во время движения&lt;/h1&gt;

&lt;p&gt;webcam_motion on&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;выкрутил-в-максимум-чтобы-избежать-срабатывания-на-включение-света:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Выкрутил в максимум, чтобы избежать срабатывания на включение света&lt;/h1&gt;

&lt;p&gt;lightswitch 100&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;кол-во-кадров-с-движением-необходимых-для-генерации-события:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Кол-во кадров с движением, необходимых для генерации события&lt;/h1&gt;

&lt;p&gt;minimum_motion_frames 3&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;записать-кадры-до-движения:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Записать кадры до движения&lt;/h1&gt;

&lt;p&gt;pre_capture 5&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;записать-кадры-после-движения:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Записать кадры после движения&lt;/h1&gt;

&lt;p&gt;post_capture 5&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;маска-для-определения-области-детекции-легко-делается-в-gimp-е-из-снимка-с-камеры:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Маска для определения области детекции, легко делается в Gimp’е из снимка с камеры.&lt;/h1&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;области-закрашенные-черным-игнорируются:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Области, закрашенные черным, игнорируются.&lt;/h1&gt;

&lt;p&gt;mask_file /path/to/mask.pgm&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;время-определения-окончания-движения-если-за-15-секунд-после-начала-движения:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Время определения окончания движения <span class="o">(</span>если за <span class="m">15</span> секунд после начала движения&lt;/h1&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;не-было-никаких-поползновений-то-считаем-что-событие-движение-закончилось:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;не было никаких поползновений, то считаем, что событие-движение закончилось<span class="o">)</span>&lt;/h1&gt;

&lt;p&gt;gap 15&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;отключить-создание-снимков:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Отключить создание снимков&lt;/h1&gt;

&lt;p&gt;output_normal off&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;обозначать-движение-прямоугольником:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Обозначать движение прямоугольником&lt;/h1&gt;

&lt;p&gt;locate on&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;запуск-скрипта-по-началу-движения-это-симлимк-который-указывает-на-реальный-скрипт:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Запуск скрипта по началу движения <span class="o">(</span>это симлимк, который указывает на реальный скрипт<span class="o">)</span>.&lt;/h1&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;изменение-симлинка-осущестляется-по-команде-с-пульта-см-п-2-про-конфиг:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Изменение симлинка осущестляется по команде с пульта <span class="o">(</span>см. п. <span class="m">2</span> про конфиг<span class="o">)</span>&lt;/h1&gt;

&lt;p&gt;on_event_start “/etc/motion/handlers/on_event_start”&lt;/p&gt;
</pre></div>
</p>

<p>Для подгонки чувствительности, порога шумов и т.д., нужно использовать setup mode, который активируется при запуске <code>
motion -s</code>.</p>

<p>При этом в mjpeg-трансляции область детекции будет обозначена черным, шумы — серым, а распознанное движение — синим.</p>

<p><strong>2.</strong> Для управления нетбуком был использован <a href="http://www.dx.com/p/multimedia-ir-remote-controller-with-usb-receiver-for-pc-1-cr2025-26368#.VGYO33WUe24">ИК-пульт с USB-приемником</a>. Подобные пульты есть и на aliexpress, и ebay. USB-приемник эмулирует HID-устройство, по сути — обычную клавиатуру.</p>

<p>Для работы с символьными устройствами ввода в Linux есть подсистема <a href="http://en.wikipedia.org/wiki/Evdev">evdev</a>. Потестить распознавание сигналов с пульта можно с помощью утилиты <a href="http://manpages.ubuntu.com/manpages/trusty/man1/evtest.1.html">evtest</a>.</p>

<p>На гитхабе нашелся <a href="https://github.com/gvalkov/golang-evdev">пакет для работы с evdev на Go</a>. Проект больше не поддерживается, так что я отфоркался от <a href="https://github.com/ungerik/golang-evdev">более свежего форка</a> и сделал rebase на ядро Ubuntu 14.04 (3.13.0-39-generic на данный момент):</p>

<pre><code>cd evdev
make ecodes.go
</code></pre>

<p>Поверх golang-evdev я написал <a href="https://github.com/dddpaul/go-evhandler">evhandler</a>. Эта программа запускается от root&rsquo;а и слушает события от input device, указанного в конфиге (как правило, <em>/etc/evhandler.toml</em>).  Мой конфиг:</p>

<pre><code>[params]
    device = &quot;/dev/input/event9&quot;

[actions]
    KEY_STOPCD = &quot;service motion stop&quot;
    KEY_PLAYPAUSE = &quot;service motion start&quot;
    KEY_PAGEUP = &quot;/etc/motion/handlers/handler-select up&quot;
    KEY_PAGEDOWN = &quot;/etc/motion/handlers/handler-select down&quot;
</code></pre>

<p>В разделе <em>actions</em> на кнопки пульта вешаются команды: остановка и запуск motion, и выбор скрипта, который будет запущен при детекции движения. Скрипт <em>handler-select</em> &ldquo;передвигает&rdquo; симлинк <em>on_event_start</em> вверх/вниз, устанавливая, таким образом, реальный скрипт, который будет запускаться. Коллекцию этих скриптов я выложил в <a href="https://github.com/dddpaul/motion-handlers">отдельный проект</a>.</p>

<p>Для чтения и парсинга конфигов я использовал пакет <a href="http://spf13.com/project/viper">Viper</a>. Это очень классная либа от автора <a href="http://gohugo.io/">Hugo</a>, которая умеет:</p>

<ul>
<li>парсить YAML, TOML и JSON;</li>
<li>искать конфиги в разных местах (например, сначала в $HOME, а потом в <em>/etc</em>);</li>
<li>устанавливать значение по-умолчанию и переопределять значения из конфига значениями из CLI.</li>
</ul>

<p><strong>3.</strong> evhandler должен использовать в качестве стандартного вывода <em>/dev/tty1</em>. Сделать это очень просто.</p>

<p>Сначала отключим ввод с <em>/dev/tty1</em> — <code>rm /etc/init/tty1.conf</code>.</p>

<p>И создадим новый upstart job в <em>/etc/init/evhandler.conf</em>:</p>

<p><div class="highlight"><pre>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;evhandler-simple-key-press-listener-and-handler-written-in-go:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;evhandler - Simple key press listener and handler written in Go&lt;/h1&gt;

&lt;p&gt;start on runlevel <span class="o">[</span>2345<span class="o">]</span>
stop on runlevel <span class="o">[</span>!2345<span class="o">]</span>&lt;/p&gt;

&lt;p&gt;respawn&lt;/p&gt;

&lt;p&gt;exec /path/to/go-evhandler &gt; /dev/tty1 2&gt;<span class="p">&amp;</span>1&lt;/p&gt;
</pre></div>
</p>

<p>Теперь evhandler будет запускаться при загрузке, а также перезапускаться, если его процесс будет прибит. Для ручного запуска — <code>
start evhandler</code>.</p>

<ol>
<li>Управлять включением энергосберегающего режима (а именно, гашением экрана) можно з-мя способами:</li>
<li>указать <code>consoleblank=sss</code> (где sss - секунды) в параметрах ядра (<em>GRUB_CMDLINE_LINUX</em> в <em>/etc/default/grub</em>);</li>
<li>использовать команду <code>setterm -blank mm</code> (где mm - минуты), для включения — <code>setterm -blank poke</code>;</li>
<li>использовать специальные ESC-последовательности в команде <code>echo</code>.</li>
</ol>

<p><code>consoleblank</code> давал странный эффект - после загрузки системы экран становился пустым, но было видно, что подсветка работает. При нажатии клавиш он загорался и полностью погасал через заданное время.</p>

<p><code>setterm</code> через ssh у меня как-то не заработал.</p>

<p>И только управляющая ESC-последовательность для терминала подошла отлично — <code>echo -e '\033[9;X]</code> (где X - минуты).</p>

<p>Для автоматического запуска этой команды создадим job <em>/etc/init/tty1.conf</em>:</p>

<p><div class="highlight"><pre>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;tty1-getty:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;tty1 - getty&lt;/h1&gt;

&lt;p&gt;#&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;this-service-is-used-to-maintain-a-getty-on-tty1-from-the-point-the-system-is:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;This service is used to maintain a getty on tty1 from the point the system is&lt;/h1&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;started-until-it-is-shut-down-again:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;started <span class="k">until</span> it is shut down again.&lt;/h1&gt;

&lt;p&gt;start on stopped rc <span class="nv">RUNLEVEL</span><span class="o">=[</span>2345<span class="o">]</span> and <span class="o">(</span>
            not-container or
            container <span class="nv">CONTAINER</span><span class="o">=</span>lxc or
            container <span class="nv">CONTAINER</span><span class="o">=</span>lxc-libvirt<span class="o">)</span>&lt;/p&gt;

&lt;p&gt;stop on runlevel <span class="o">[</span>!2345<span class="o">]</span>&lt;/p&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;blank-screen-after-1-minute-timeout:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;Blank screen after <span class="m">1</span> minute timeout&lt;/h1&gt;

&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;see-http-www-armadeus-com-wiki-index-php-title-framebuffer:dd5d68c20919ac64bfba0b5fb31117b8&quot;</span>&gt;See &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.armadeus.com/wiki/index.php?title=FrameBuffer&quot;</span>&gt;http://www.armadeus.com/wiki/index.php?title<span class="o">=</span>FrameBuffer&lt;/a&gt;&lt;/h1&gt;

&lt;p&gt;exec <span class="nb">echo</span> -ne “<span class="se">\0</span>33<span class="o">[</span>9<span class="p">;</span>1<span class="o">]</span>” &gt; /dev/tty1&lt;/p&gt;
</pre></div>
</p>

<p>Ссылки:</p>

<ul>
<li><a href="https://github.com/dddpaul/go-evhandler">Evhandler : Simple key press listener and handler written in Go</a></li>
<li><a href="http://spf13.com/project/viper">Viper : Go Configuration Management With Fangs</a></li>
<li><a href="http://superuser.com/a/154388">Change Linux console screen blanking behavior</a></li>
<li><a href="http://raspberrypi.stackexchange.com/questions/10374/wake-console-screen-with-ssh">Wake console screen with SSH</a></li>
<li><a href="http://www.armadeus.com/wiki/index.php?title=FrameBuffer">ArmadeusWiki - Framebuffer</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/10/21/android-memory-leak-badoo/">
                    Борьба с утечками памяти в Android (Badoo)
                </a>
            </h1>

            <span class="post-date">2014-10-21</span>

            

<p>На хабре появилась статья <a href="http://habrahabr.ru/company/badoo/blog/240479/">Борьба с утечками памяти в Android. Часть 1</a> от компании Badoo. Т.к. тема созвучна с моими постами из серии 
<a href='http://dddpaul.github.io/blog/series/memory-leaks'>Memory leaks</a>, то решил вкратце описать их методы.</p>

<p>Суть проблемы — использование android.os.Handler, в который постится анонимный Runnable с помощью метода <a href="http://developer.android.com/reference/android/os/Handler.html#postDelayed(java.lang.Runnable, long">postDelayed</a>. Для демонстрации, Runnable просто меняет какой-либо TextView (т.е. содержит внутри себя ссылку mTextView), и время до выполнения Runnable берется довольно большим. Так вот, если за этот промежуток времени повернуть девайс несколько раз, то старые активити не будут собираться GC, т.к. в Java любой анонимный класс всегда имеет неявную ссылку на внешний класс.</p>

<h3 id="решение-с-использованием-статического-класса:b5ecc8a59da209189d194d532f575ae4">Решение с использованием статического класса</h3>

<p>Переделка анонимного класса в статический проблему не решает — Activity сохранен в ссылке mContext из mTextView внутри нашей реализации Runnable.</p>

<h3 id="решение-с-использованием-статического-класса-и-weakreference:b5ecc8a59da209189d194d532f575ae4">Решение с использованием статического класса и WeakReference</h3>

<p>В реализации Runnable сохраняем ссылку на TextView в WeakReference. Использование WeakReference требует особой аккуратности: такая ссылка в любой момент может обнулиться. Поэтому сначала сохраняем ссылку в локальную переменную и работаем только с последней, проверив ее на null.</p>

<p>Для использования данного подхода нам необходимо:</p>

<ul>
<li>использовать статический внутренний или внешний класс;</li>
<li>использовать WeakReference для всех объектов, на которые мы ссылаемся.</li>
</ul>

<p>Это решает проблему.</p>

<h3 id="очистка-всех-сообщений-в-ondestroy:b5ecc8a59da209189d194d532f575ae4">Очистка всех сообщений в onDestroy</h3>

<p>Добавим в onDestroy вызов метода класса Handler <a href="http://developer.android.com/reference/android/os/Handler.html#removeCallbacksAndMessages(java.lang.Object)">removeCallbacksAndMessages</a>. Он удаляет все сообщения, находящиеся в очереди данного Handler&rsquo;а. Это очень хороший способ защититься от утечки памяти, но во-первых, нужно не забыть это сделать, а во-вторых, в комментах к статье пишут, что вызов onDestroy в общем случае не гарантирован.</p>

<p>Цитата из документации — <a href="http://developer.android.com/training/basics/activity-lifecycle/stopping.html">Stopping and Restarting an Activity</a>:</p>

<blockquote>
<p>When your activity receives a call to the onStop() method, it&rsquo;s no longer visible and should release almost all resources that aren&rsquo;t needed while the user is not using it. Once your activity is stopped, the system might destroy the instance if it needs to recover system memory. In extreme cases, the system might simply kill your app process without calling the activity&rsquo;s final onDestroy() callback, so it&rsquo;s important you use onStop() to release resources that might leak memory.</p>
</blockquote>

<h3 id="решение-с-использованием-weakhandler:b5ecc8a59da209189d194d532f575ae4">Решение с использованием WeakHandler</h3>

<p>Команда Badoo написала свой Handler — <a href="github.com/badoo/android-weak-handler">WeakHandler</a>. Это класс, который ведет себя совершенно как Handler, но исключает утечки памяти за счет использования слабых ссылок.</p>

<p>Главная идея — держать жесткую ссылку на сообщения или Runnable до тех пор, пока существует жесткая ссылка на WeakHandler. Как только WeakHandler может быть удален из памяти, все остальное должно быть удалено вместе с ним.</p>

<h3 id="выводы:b5ecc8a59da209189d194d532f575ae4">Выводы</h3>

<p>Отличная и годная статья :)</p>

<p>Ссылки:</p>

<ul>
<li><a href="http://corner.squareup.com/2013/10/android-main-thread-1.html">A journey on the Android Main Thread - PSVM</a>. Рассказ про про внутренности Main Thread: Loopers, Handlers и т.д.</li>
<li><a href="http://corner.squareup.com/2013/12/android-main-thread-2.html">A journey on the Android Main Thread - Lifecycle bits</a>. Продолжение — про lifecycle и orientation change.</li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/10/16/angularjs-directive/">
                    Директивы AngularJS
                </a>
            </h1>

            <span class="post-date">2014-10-16</span>

            <p>Статьи:</p>

<ul>
<li><a href="http://statelessprime.blogspot.ru/2013/04/angularjs-directive-overview.html">AngularJS directive: Overview</a>. Очень крутой сборник статей про директивы. Помогает понять, как правильно создать шаблон директивы вручную (через функции compile и link), а также, как навесить watches.</li>
<li><a href="http://www.benlesh.com/2013/08/angularjs-watch-digest-and-apply-oh-my.html">AngularJS: $watch, $digest and $apply</a>. Еще раз об этих базовых функциях AngularJS почитать никогда не вредно.</li>
<li>A Practical Guide to AngularJS Directives - <a href="http://www.sitepoint.com/practical-guide-angularjs-directives/">Part 1</a>, <a href="http://www.sitepoint.com/practical-guide-angularjs-directives-part-two/">Part 2</a>. Подробно про директивы.</li>
<li><a href="http://odetocode.com/blogs/scott/archive/2013/09/11/moving-data-in-an-angularjs-directive.aspx">Moving Data In An AngularJS Directive</a>. Передача данных в директиву.</li>
<li><a href="http://www.undefinednull.com/2014/02/11/mastering-the-scope-of-a-directive-in-angularjs/">Mastering the Scope of the Directives in AngularJS</a>. Очень подробно разжевано про scope в директивах.</li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2014/08/02/orientation-change/">
                    Подводные камни смены ориентации в Android
                </a>
            </h1>

            <span class="post-date">2014-08-02</span>

            

<p>После нескольких дней отладки приложения пришел к выводу, что смена ориентации (rotation, orientation change) требует к себе особого внимания. Наконец-то я понял тех разработчиков, которые напрочь запрещают смену ориентации в своем софте. Ведь, не зная некоторых неочевидных нюансов, можно легко получить крах приложения или утечку памяти.</p>

<p>Опишу в порядке возрастания сложности, на какие подводные камни мне пришлось натолкнуться.</p>

<h3 id="beginner-s-level:ab7bd6db0fbb770c5dbfe85b3a43d6b3">Beginner&rsquo;s level</h3>

<p>Надо сохранять состояние (state) фрагментов. Не сохранил — потерял, т.к. активити и фрагменты будут пересозданы. Если стейт фрагмента сериализуется в строку, то просто переопределяем метод onSaveInstanceState(). Способ описан как в <a href="http://developer.android.com/guide/components/fragments.html#Lifecycle">официальной документации</a>, так и в множестве других мест.</p>

<h3 id="intermediate:ab7bd6db0fbb770c5dbfe85b3a43d6b3">Intermediate</h3>

<p>Не забываем про AsyncTask. Их тоже надо сохранять, ибо иначе при смене ориентации мы его потеряем. Или он что-нибудь обвалит :) Для решения этой проблемы придумана такая отличная штука, как retaining fragments. Всего один вызов setRetainInstance(true) продляет жизнь фрагменту и связанному с ним асинктаску (назовем это длинный стейт).</p>

<p>Тут и начинаются подводные камни. Что если мы хотим в портретном режиме свайпить фрагменты (через ViewPager), а в landscape — просто показать их всех в линеечку (с помощью LinearLayout безо всякого ViewPager)? Запустим приложение в portrait mode, перевернем, и получим &ldquo;IllegalArgumentException: No view found&rdquo;.</p>

<p>Суть в том, что изначальный фрагмент с портретного режима останется и даже сохранит ссылку на ViewPager, которого в landscape layout уже просто нет :) Отсюда вывод - использовать для сохранения длинного стейта нужно headless fragments, т.е. фрагменты без UI. Тогда получается красиво: в &ldquo;обычных&rdquo; фрагментах формочки и кнопочки, а асинктаски — в отдельных, которые ничего про UI не знают.</p>

<p>Остался последний вопрос — как этот headless fragment создать/запустить? В android-samples есть пример <a href="https://android.googlesource.com/platform/development/+/master/samples/ApiDemos/src/com/example/android/apis/app/FragmentRetainInstance.java">FragmentRetainInstance.java</a>, в котором используется способ матрешки - активити запускает parent fragment, parent запускает worker fragment, внутри которого сидит асинктаск.</p>

<p>Вроде хорошая схема, но если вы, не дай бог, возьмете Robolectric и напишите юнит-тест для родительского фрагмента, то получите что-то типа recursive transaction exception. Суть в том, что роболектрик создает тестируемый фрагмент обычным способом (через транзакцию), а внутри запускается новая транзакция (для worker fragment). А так нельзя, это вам не JPA какой-нибудь :)</p>

<p>Итого — держим асинктаски в headless-фрагменте, который запускаем из активити. В целом, это отличная схема на все случаи жизни, а не только для приведенного примера.</p>

<h3 id="veteran:ab7bd6db0fbb770c5dbfe85b3a43d6b3">Veteran</h3>

<p>Копаем в сторону уже вскользь упомянутого multi-pane. Как его сделать правильно на одних фрагментах? Внятно описанный <a href="http://www.vogella.com/tutorials/AndroidFragments/article.html">способ от Ларса Вогеля</a> требует разных активити, а я не хочу плодить сущности.</p>

<p>Используем уже описанный метод с двумя layout&rsquo;ами (ведь мы же за декларативный подход!):</p>

<ul>
<li>1-й layout состоит из одного ViewPager&rsquo;а;</li>
<li>2-й — LinearLayout с двумя фрагментами.</li>
</ul>

<p>В чем прелесть подхода — 2-й layout можно положить в папочку, например, layout-w600dp и он будет автоматически использован, если ширина экрана больше 600dp. Красота!</p>

<p>Оно даже работает и не падает. Правда, появился какой-то странный глюк с <a href="http://github.com/greenrobot/EventBus">EventBus</a>: иногда фрагмент получает два сообщения вместо одного. При более пристальном изучении оказалось наоборот - два одинаковых фрагмента получают одно сообщение. Откуда они берутся? А кто его знает :)</p>

<p>Была убита куча времени в DDMS/VisualVM/MAT, в результате чего появился <a href="https://github.com/dddpaul/android-ViewPagerBug">тестовый проект</a>, также описал симптомы на <a href="http://stackoverflow.com/questions/25033824/dublicate-fragment-allocation-when-using-viewpager-with-different-layouts">StackOverflow</a>. Вкратце, именно при использовании такого варианта multi-pane (когда в одном layout есть ViewPager, а в другом нет), фрагменты при перевороте создаются ДВАЖДЫ. Причем, оба в RESUMED state, поэтому они оба и ловят сообщения по EventBus.</p>

<p>Плюнув, отказался от второго layout&rsquo;а, теперь ViewPager используется везде. Чтобы показать сразу 2 фрагмента, можно использовать разные <a href="http://commonsware.com/blog/2012/08/20/multiple-view-viewpager-options.html">хитрые способы</a>. Они, в общем, несложные, и, в моем случае, способ с переопределением getPageWidth() даже не внес никаких сайд-эффектов. Правда, определение ширины экрана, когда надо показать multi-pane пришлось вынести в код, получилось чуть менее декларативненько.</p>

<h3 id="hardcore:ab7bd6db0fbb770c5dbfe85b3a43d6b3">Hardcore</h3>

<p>Плавно переходим к утечкам памяти :)</p>

<p>Очень веселая ситуация, когда после, например, после 10 ротаций эмулятора и нескольких запусков GC в хипе болтаются 11 activities. Решив идти до конца, вооружившись методом исключения и вырезав почти весь код и вьюхи, удалось докопаться до причины. Утекал компонент TextView с опцией <a href="http://stackoverflow.com/questions/22990634/textview-with-id-and-textisselectable-true-causes-leaking-of-the-activity-obje">textIsSelectable=&ldquo;true&rdquo;</a>. Очень порадовало начало топика &ldquo;It took me three days to narrow my problem &hellip;&rdquo; :)</p>

<p>Убрал одну строчку в layout, утечка исчезла, ура. Вернулся в основную ветку, вставил этот коммит, прогнал тест (10 ротаций), получил 10 activities. Уже лучше :)</p>

<p>Оказалось, компонент EditText также замечательно утекает. Причина, вроде бы в том, что он слишком умный (у него по-умолчанию включен спеллчекер). Если отключить, то утечка может пропасть, а может и нет. Прогнал тест на разных эмуляторах, оказалось, что в 4.3 баг починен, уже хорошо! А я все тестил на 4.1.2.</p>

<p>Раз версия 4.3 такая замечательная, может быть, там починена утечка textIsSelectable? А то вдруг понадобится эта опция? Нет, все без изменений. Версия 4.4.2? А вот фиг вам - <a href="https://code.google.com/p/android/issues/detail?id=61671">баг в эмуляторе</a>. Вы не можете повернуть эмулятор с этой версией Андроида :) Тест запустить не удалось.</p>

<p>Фрагменты также могут утекать. В сети полно примеров организации свайпа с ViewPager (это где фрагменты создаются в классе-потомке FragmentPagerAdapter и т.д.) Все замечательно, но не забываем вставлять в onDestroy():</p>

<pre><code>pager.removeAllViews();
pager.setAdapter( null );
</code></pre>

<p>Иначе, каждый раз при rotation старые фрагменты не будут собираться GC. Если у вас приложение с 2-мя фраментами, то после 10 ротаций будет 22, плюс 11 activities. По крайней мере, в 4.1.2. В 4.3 уже можно этим не заморачиваться :)</p>

<h3 id="заключение:ab7bd6db0fbb770c5dbfe85b3a43d6b3">Заключение</h3>

<p>К чему весь этот пост - выложил обновление <a href="https://play.google.com/store/apps/details?id=com.github.dddpaul.netcat">Simple NetCat</a>. Версия 1.4 поддерживает multi-pane на планшетах, содержит меньше багов (скрестил два пальца) и практически не течет по памяти.</p>

        </div>
        
    </div>


</body>
</html>
