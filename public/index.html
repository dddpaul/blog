<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.16-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Dev notes &middot; Dev notes </title>

  
  <link rel="stylesheet" href="https://dddpaul.github.io/blog/css/poole.css">
  <link rel="stylesheet" href="https://dddpaul.github.io/blog/css/syntax.css">
  <link rel="stylesheet" href="https://dddpaul.github.io/blog/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="https://dddpaul.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="Dev notes" />
</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Dev notes</h1>
            <p class="lead">
                 Notes about Android, Java, JavaScript, Go and other technical stuff 
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="http://google.com/&#43;PavelDerendyaev1"> Google&#43; </a></li>
            
            <li><a href="/blog/index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="https://dddpaul.github.io/blog//tags/android/">android</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/angularjs/">angularjs</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/ansible/">ansible</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/concurrency/">concurrency</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/database/">database</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/devops/">devops</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/docker/">docker</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/git/">git</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/golang/">golang</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/hugo/">hugo</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/java/">java</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/javascript/">javascript</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/linux/">linux</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/python/">python</a> </li>
            
            <li><a href="https://dddpaul.github.io/blog//tags/react/">react</a> </li>
            
        </ul>

        <p>&copy; 2016. All rights reserved. </p>
    </div>
</div>


<div class="content container">
    <div class="posts">

        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/08/02/docker-network-swarm-links/">
                    Docker network and Swarm mode links
                </a>
            </h1>

            <span class="post-date">2016-08-02</span>

            <p>Some useful articles &amp; videos about modern networking in Docker:</p>

<ul>
<li><a href="https://github.com/docker/libnetwork/blob/master/docs/macvlan.md">Macvlan Driver</a> - Docker Macvlan driver is out of experimental in Docker 1.12.</li>
<li><a href="http://networkstatic.net/configuring-macvlan-ipvlan-linux-networking/">Configuring Macvlan and Ipvlan Linux Networking</a> - What Docker Macvlan driver does under the hood.</li>
<li><a href="https://github.com/lowescott/2016-dnf-materials">Materials for 2016 DevOps Networking Forum (DNF) Presentation</a> - Slides about Docker networking with Ansible playbooks.</li>
<li><a href="https://habrahabr.ru/company/badoo/blog/304702/">Видео докладов с Docker митапа</a> - Особо интересен доклад Константина Назарова &ldquo;Каждому контейнеру по IP&rdquo; (на русском).</li>
</ul>

<p>Swarm mode was presented in Docker 1.12:</p>

<ul>
<li><a href="https://blog.docker.com/2016/07/docker-built-in-orchestration-ready-for-production-docker-1-12-goes-ga/">Docker Built-In Orchestration Ready For Production: Docker 1.12 Goes GA</a> - Post from Docker blog about Swarm mode release. It contains some links to the videos.</li>
<li><a href="http://blog.hypriot.com/post/more-microservice-bliss-with-docker-1-12/">More Microservices Bliss with Docker 1.12 and Swarm only</a> - Seems like <a href="https://traefik.io/">Traefik</a> can be partially replaced with Docker 1.12. routing mesh.</li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/07/15/golang-profiling-links/">
                    Golang profiling links
                </a>
            </h1>

            <span class="post-date">2016-07-15</span>

            <p>Some useful articles &amp; videos about profiling &amp; benchmarking Go programs:</p>

<ul>
<li><a href="http://lk4d4.darth.io/posts/bench/">Go Benchmarks</a> - How to write and use benchmarks</li>
<li><a href="http://dave.cheney.net/2013/07/07/introducing-profile-super-simple-profiling-for-go-programs">Introducing profile, super simple profiling for Go programs</a> - A simple way to profile an existing Go program.</li>
<li><a href="http://blog.ralch.com/tutorial/golang-performance-and-memory-analysis/">Performance and memory analysis of Golang programs</a> - Performance metrics analysis.</li>
<li><a href="http://eax.me/go-profiling/">Профилирование в Go (гостевой пост Владимира Солонина)</a> - Доступно о профилировании на русском.</li>
<li><a href="https://habrahabr.ru/company/badoo/blog/302134/">Видео докладов с Весеннего Go митапа</a> - Особо интересен доклад Марко Кеваца о профилировании (на русском).</li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/04/15/react-for-starters/">
                    Быстрое погружение в React
                </a>
            </h1>

            <span class="post-date">2016-04-15</span>

            <p>Для разогрева:</p>

<ul>
<li><a href="https://facebook.github.io/react/docs/tutorial.html">React tutorial</a></li>
<li><a href="https://ru.hexlet.io/courses/reactjs">Курс на Хекслете</a></li>
</ul>

<p>После этого более-менее должно оформиться понимание, что:</p>

<ul>
<li>React - это V в MVC;</li>
<li>основа React - это компоненты;</li>
<li>у компонента есть главный метод render(), который дергается React&rsquo;ом, когда нужно отобразить или перерисовать компонент;</li>
<li>компоненты инициализируется через properties, и хранят state;</li>
<li>компоненты пишутся на JSX - специальный синтаксис, который &ldquo;бесшовно&rdquo; внедряет HTML в JS;</li>
<li>компоненты можно связывать в иерархические структуры;</li>
<li>состояние нельзя менять напрямую, а только через специальный метод setState() - таким образом React точно узнает, что состояние изменилось и объект надо перерисовать;</li>
<li>состояние принято хранить в родительском компоненте, и передавать его в дочерние компоненты через properties.</li>
</ul>

<p>Далее надо слегка погрузиться в ECMAScript 6 aka ES2015:</p>

<ul>
<li><a href="https://learn.javascript.ru/es-modern-usage">ES-2015 сейчас</a> - введение</li>
<li><a href="https://babeljs.io/docs/learn-es2015/">Learn ES2015</a> - кратенько про отличия от ES5</li>
<li><a href="http://www.2ality.com/2012/07/esnext-classes.html">ECMAScript 6: classes</a> - новый синтаксис классов</li>
<li><a href="http://www.2ality.com/2012/04/arrow-functions.html">ECMAScript 6: arrow functions and method definitions</a> - лямбды!</li>
<li><a href="http://www.benmvp.com/learning-es6-enhanced-object-literals/">Learning ES6: Enhanced object literals</a> - less boilerplate in objects</li>
<li><a href="https://habrahabr.ru/post/262183/">React на ES6+</a> - кратко обо всем, пока не читал</li>
</ul>

<p>Теперь рекомендую форкнуть <a href="https://github.com/reactjs/react-tutorial">React tutorial</a> и поиграться с ним, например:</p>

<ul>
<li>перевести проект на Webpack для дальнейшей работы с модулями, см. <a href="https://www.twilio.com/blog/2015/08/setting-up-react-for-es6-with-webpack-and-babel-2.html">Setting up React for ES6 with Webpack and Babel</a></li>
<li>подключить live and <a href="http://gaearon.github.io/react-hot-loader/getstarted/">hot reload</a>;</li>
<li>заменить &ldquo;var&rdquo; на &ldquo;let/const&rdquo;;</li>
<li>заменить определения методов внутри объектов (Enhanced object literals);</li>
<li>заменить потенциально опасные манипуляции со сложным стейтом (объекты, массивы) с помощью <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Array/splice">Array.prototype.splice()</a> или <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Array/concat">Array.prototype.concat()</a> на изменения с помощью идеологически верных <a href="https://facebook.github.io/react/docs/update.html">Immutability Helpers</a>;</li>
<li>заменить XHR-вызовы через jQuery на что-то более REST&rsquo;овое, например <a href="https://github.com/github/fetch">fetch API</a>.</li>
</ul>

<hr />

<p>Кракая выжимка для начала работы с Webpack:</p>

<pre><code>npm install --save react
npm install --save react-dom
npm install --save-dev webpack
npm install --save-dev babel-loader
npm install --save-dev babel-core
npm install --save-dev babel-preset-es2015
npm install --save-dev babel-preset-react
npm install --save-dev react-hot-loader
</code></pre>

<p>Для запуска webpack-dev-server надо запустить в $HOME:</p>

<pre><code>npm install webpack-dev-server
</code></pre>

<p>В этом случае webpack-dev-server будет установлен в $HOME/node_modules, и симлинк на него будет в $HOME/node_modules/.bin. Этот каталог уже можно включить в $PATH и запускать webpack и webpack-dev-server из любого места.</p>

<p>Типовое содержимое webpack.config.js:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">webpack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpack&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">entry</span><span class="o">:</span> <span class="s1">&#39;./public/scripts/example.js&#39;</span><span class="p">,</span>
  <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/public/build&quot;</span><span class="p">,</span>
    <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;bundle.js&#39;</span>
  <span class="p">},</span>
  <span class="nx">module</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">loaders</span><span class="o">:</span> <span class="p">[{</span>
      <span class="nx">test</span><span class="o">:</span> <span class="sr">/.jsx?$/</span><span class="p">,</span>
      <span class="nx">loaders</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;react-hot&quot;</span><span class="p">,</span> <span class="s2">&quot;babel-loader?presets[]=react,presets[]=es2015&quot;</span><span class="p">],</span>
      <span class="nx">exclude</span><span class="o">:</span> <span class="sr">/node_modules/</span>
    <span class="p">}]</span>
  <span class="p">},</span>
  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">HotModuleReplacementPlugin</span><span class="p">(),</span>
    <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">NoErrorsPlugin</span><span class="p">(),</span> <span class="c1">// don&#39;t reload if there is an error</span>
  <span class="p">]</span>
<span class="p">};</span>
</code></pre></div>


<p>Теперь можно запустить <code>webpack -w</code> и, при любых изменениях js-файлов, будет автоматически пересобираться bundle.js. Reload в браузере все-таки придется сделать. Полноценный hot&amp;live reload можно организовать только с помощью webpack-dev-server.</p>

<hr />

<p>Про модули:</p>

<ul>
<li><a href="http://frontender.info/es6-modules/">Модули в ECMAScript 6: будущее уже сейчас</a></li>
<li><a href="http://www.2ality.com/2015/12/babel-commonjs.html">Babel and CommonJS modules</a></li>
<li><a href="http://frontender.info/packing-the-web-like-a-boss/">Пакуем как боги</a></li>
<li><a href="https://habrahabr.ru/post/250103/">Как мы готовим React, Require и Backbone</a></li>
<li><a href="https://medium.com/@rajaraodv/webpack-the-confusing-parts-58712f8fcad9#.7ffl30blv">Webpack — The Confusing Parts</a></li>
</ul>

<p>Про компоненты:</p>

<ul>
<li><a href="https://facebook.github.io/react/docs/reusable-components.html">Reusable Components</a> - пока не читал</li>
</ul>

<hr />

<p>Внедрение <a href="https://github.com/github/fetch">fetch API</a>:</p>

<pre><code>npm install --save whatwg-fetch
npm install --save imports-loader exports-loader
</code></pre>

<p>Остальные ссылки по fetch:</p>

<ul>
<li><a href="https://davidwalsh.name/fetch">fetch API</a></li>
<li><a href="https://habrahabr.ru/post/252941/">Введение в fetch</a></li>
<li><a href="https://hacks.mozilla.org/2015/03/this-api-is-so-fetching/">This API is so Fetching!</a></li>
<li><a href="http://mts.io/2015/04/08/webpack-shims-polyfills/">Using webpack with shims and polyfills</a></li>
</ul>

<hr />

<p>Переходим к тяжелым упражнениям:</p>

<ul>
<li><a href="https://spring.io/guides/tutorials/react-and-spring-data-rest/">React.js and Spring Data REST</a> - мегаматериал про связку со Spring Boot</li>
</ul>

<p>Чтобы не ставить nodejs, npm и bower локально, можно использовать:</p>

<ul>
<li><a href="https://github.com/eirslett/frontend-maven-plugin">Frontend maven plugin</a> - для проектов на Java</li>
<li>Docker-образ <a href="https://github.com/DigitallySeamless/docker-nodejs-bower-grunt">Node.js w/ Bower &amp; Grunt</a> - для всего остального</li>
</ul>

<p>Но проще всего установить nodejs &amp; npm с <a href="https://nodejs.org">https://nodejs.org</a>.</p>

<p>Дополнительные компоненты:</p>

<ul>
<li><a href="https://react-bootstrap.github.io/">React-Bootstrap</a> - Bootstrap-компоненты, переписанные на React</li>
<li><a href="https://github.com/AllenFang/react-bootstrap-table">react-bootstrap-table</a> - крутая Bootstrap-compartible табличка</li>
</ul>

<p>Тестирование:</p>

<ul>
<li><a href="http://facebook.github.io/react/docs/test-utils.html">ReactTestUtils</a></li>
</ul>

<p>Просто интересные ресурсы:</p>

<ul>
<li><a href="http://geowarin.github.io/spring-boot-and-react-hot.html">Spring Boot and React hot loader</a> - пока не читал</li>
<li><a href="https://blog.risingstack.com/the-react-way-getting-started-tutorial/">The React.js Way: Getting Started Tutorial</a> - пока не читал</li>
<li><a href="https://github.com/winterbe/spring-react-example">Spring Boot React Example</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2016/03/17/linearizability-and-serializability/">
                    Linearizability, serializability, transaction isolation and consistency models
                </a>
            </h1>

            <span class="post-date">2016-03-17</span>

            <p><a href="http://www.bailis.org/blog/linearizability-versus-serializability/">Linearizability versus Serializability</a>:</p>

<blockquote>
<p><strong>Linearizability</strong> is a guarantee about single operations on single objects. It provides a real-time (i.e., wall-clock) guarantee on the behavior of a set of single operations (often reads and writes) on a single object (e.g., distributed register or data item).</p>

<p>Linearizability for read and write operations is synonymous with the term “atomic consistency” and is the “C,” or “consistency,” in Gilbert and Lynch’s proof of the CAP Theorem. We say linearizability is composable (or “local”) because, if operations on each object in a system are linearizable, then all operations in the system are linearizable.</p>

<p><strong>Serializability</strong> is a guarantee about transactions, or groups of one or more operations over one or more objects. It guarantees that the execution of a set of transactions (usually containing read and write operations) over multiple items is equivalent to some serial execution (total ordering) of the transactions.</p>

<p>Serializability is the traditional “I,” or isolation, in ACID. If users’ transactions each preserve application correctness (“C,” or consistency, in ACID), a serializable execution also preserves correctness. Therefore, serializability is a mechanism for guaranteeing database correctness.</p>
</blockquote>

<hr />

<p><a href="http://blog.acolyer.org/2016/02/26/distributed-consistency-and-session-anomalies/">Distributed Consistency and Session Anomalies</a>:</p>

<blockquote>
<p>In the database systems community, the gold standard is serializability. We’ve spent plenty of time looking at this in the last couple of days. Serializability concerns transactions that group multiple operations across potentially multiple objects. A serializable schedule is one that corresponds to some ordering of the transactions such that they happen one after the other in time (no concurrent / overlapping transactions). It’s the highest form of isolation between transactions.</p>
</blockquote>


<img src='https://dddpaul.github.io/blog//media/serializable.png'/>


<blockquote>
<p>In the distributed systems community, the gold standard is linearizability. Linearizability concerns single operations on single objects. A linearizable schedule is one where each operation appears to happen atomically at a single point in time. Once a write completes, all later reads (wall-clock time) should see the value of that write or the value of a later write. In a distributed context, we may have multiple replicas of an object’s state, and in a linearizable schedule it is as if they were all updated at once at a single point in time.</p>
</blockquote>


<img src='https://dddpaul.github.io/blog//media/linearizable.png'/>


<blockquote>
<p>Also, small correction: the “C” in ACID is the <em>assumption</em> that the application program is correct (each transaction in isolation brings the database from a correct state to another correct state), whereas the AID properties are <em>guarantees</em> provided by the database. Together they imply serializability.</p>
</blockquote>

<hr />

<p><a href="https://en.wikipedia.org/wiki/Consistency_model:">https://en.wikipedia.org/wiki/Consistency_model:</a></p>

<blockquote>
<p><strong>Strict consistency</strong> is the strongest consistency model. It requires that if a process reads any memory location, the value returned by the read operation is the value written by the most recent write operation to that location.</p>

<p>The <strong>sequential consistency</strong> model as defined by Lamport(1979) is a weaker memory model than strict consistency.</p>

<p><strong>Linearizability</strong> (also known as atomic consistency) can be defined as sequential consistency with the real-time constraint.</p>

<p><strong>Causal consistency</strong> can be considered a weakening model of sequential consistency by categorizing events into those causally related and those that are not. It defines that only write operations that are causally related must be seen in the same order by all processes.</p>
</blockquote>

<hr />

<p><a href="http://blog.acolyer.org/2016/02/24/a-critique-of-ansi-sql-isolation-levels/">A Critique of ANSI SQL Isolation Levels</a>:</p>


<img src='https://dddpaul.github.io/blog//media/ansi-sql-isolation-levels.png'/>


<hr />

<p>Other articles:</p>

<ul>
<li><a href="https://aphyr.com/posts/313-strong-consistency-models">Strong consistency models</a></li>
<li><a href="http://vladmihalcea.com/2014/09/14/a-beginners-guide-to-database-locking-and-the-lost-update-phenomena/">A beginner’s guide to database locking and the lost update phenomena</a></li>
<li><a href="http://blog.acolyer.org/2016/02/25/generalized-isolation-level-definitions/">Generalized Isolation Level Definitions</a></li>
<li><a href="http://www.postgresql.org/docs/current/static/transaction-iso.html">PostgreSQL - 13.2. Transaction Isolation</a></li>
<li><a href="https://habrahabr.ru/post/258145/">Забудьте САР теорему как более не актуальную</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/12/21/spring-boot-uri-encoding/">
                    Different URI encodings for one Tomcat-based application
                </a>
            </h1>

            <span class="post-date">2015-12-21</span>

            

<p>There some cases when you would like to map different URI encodings on different HTTP endpoints. And one of those cases is when your application handles GET requests containing <a href="https://en.wikipedia.org/wiki/Percent-encoding">percent-encoded</a> non-ASCII data in different charsets. For example, one HTTP endpoint uses standard UTF-8 while the other uses <a href="https://en.wikipedia.org/wiki/Windows-1251">Windows-1251</a>.</p>

<h2 id="plain-tomcat-way:9095423fd9c5e41ee9033ec52da6bac6">Plain Tomcat way</h2>

<p>According to <a href="http://wiki.apache.org/tomcat/FAQ/CharacterEncoding#Q2">How do I change how GET parameters are interpreted?</a> the only way to specify GET request encoding is to use by-connector <code>URIEncoding</code> attribute. For example:</p>

<pre><code class="language-xml"> &lt;Connector port=&quot;8081&quot; URIEncoding=&quot;utf-8&quot;/&gt;
 &lt;Connector port=&quot;8082&quot; URIEncoding=&quot;cp1251&quot;/&gt;
</code></pre>

<p>Then you have map servlets to different connectors somehow.</p>

<h2 id="spring-boot-multiple-http-connectors-way:9095423fd9c5e41ee9033ec52da6bac6">Spring Boot multiple HTTP connectors way</h2>

<p>Spring Boot can help you out in this matter. Although it uses the only one URI encoding which is specified in <code>server.tomcat.uri-encoding</code> parameter (&ldquo;UTF-8&rdquo; by default, see <a href="http://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html">Appendix A. Common application properties</a>), it can fire up multiple child applications residing on different ports.</p>

<p>Implementation is really simple as you can see from <a href="https://github.com/dddpaul/spring-boot-connectors/blob/master/src/main/java/com/github/dddpaul/connectors/Application.java">Spring Boot Connectors application</a>.</p>

<p>Pros:</p>

<ul>
<li>no hacks and workarounds, pure Spring Boot solution :)</li>
<li>controller unit tests are passed.
<br /></li>
</ul>

<p>Cons:</p>

<ul>
<li>some mess with controllers mappings;</li>
<li>integration tests (with full context initialization) are failed on non-ASCII requests; in fact, you have no option to point which connector are used in test;</li>
<li>say bye-bye to Spring Boot actuators, you&rsquo;ll have to use some workarounds to plug them in.<br /></li>
</ul>

<p>Links:</p>

<ul>
<li><a href="http://stackoverflow.com/questions/26111050/spring-boot-how-can-i-add-tomcat-connectors-to-bind-to-controller">Spring-Boot : How can I add tomcat connectors to bind to controller</a></li>
<li><a href="https://github.com/dddpaul/spring-boot-connectors">Multiple HTTP connectors in Spring Boot example</a></li>
</ul>

<h2 id="nginx-lua-way:9095423fd9c5e41ee9033ec52da6bac6">Nginx+Lua way</h2>

<p>Nginx being built with <a href="https://github.com/openresty/lua-nginx-module">Lua module</a> becomes a very fast non-blocking application server. They even have a <a href="http://leafo.net/lapis/">framework</a>! So the URI re-encode it&rsquo;s a quite an easy task to solve.</p>

<p>It&rsquo;s a more complicated way, but if you already use <a href="http://nginx.org/">Nginx</a> as a reverse proxy server / balancer / HTTPS terminator in front of or Java application — why not?</p>

<p>Nginx build options, functions and configuration file example can be found in <a href="https://github.com/dddpaul/docker-nginx">docker-nginx</a> project. <a href="https://github.com/dddpaul/docker-nginx/blob/master/lua/functions.lua">Function</a> to convert encoding:</p>

<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">function</span> <span class="nc">M</span><span class="p">.</span><span class="nf">iconv</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">table&quot;</span> <span class="k">then</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">do</span>
                <span class="n">val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">:</span><span class="n">iconv</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">else</span>
            <span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">:</span><span class="n">iconv</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">args</span>
<span class="k">end</span>
</code></pre></div>


<p>It converts only URI parameter values and leaves parameter names untouched. Converting is performed by iconv C library with help of <a href="http://ittner.github.io/lua-iconv/">Lua-iconv binding</a>, so it&rsquo;s very fast.</p>

<p>This Nginx config block configures Lua module, load convert function and initializes iconv:</p>

<pre><code>lua_package_path '/etc/nginx/lua/?.lua;;';
init_by_lua_block {
    functions = require(&quot;functions&quot;)
    iconv = require(&quot;iconv&quot;)
    cd = iconv.new(&quot;utf8&quot;, &quot;cp1251&quot;)
}
</code></pre>

<p>In order to re-encode URIs before proxying to Java backend use the following sample:</p>

<pre><code>location /app {
    rewrite_by_lua_block {
        if ngx.var.args == nil then return end
        local args = ngx.decode_args(ngx.var.args)
        args = functions.iconv(cd, args)
        args = ngx.encode_args(args)
        ngx.var.args = args
    }
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://localhost:8000;
}
</code></pre>

<p>Pros:</p>

<ul>
<li>no multiple connectors, listen on single port;</li>
<li>extremely fast, no performance drawback;</li>
<li>all tests are passed.
<br /></li>
</ul>

<p>Cons:</p>

<ul>
<li>extra devops work :)</li>
</ul>

<p>Links:</p>

<ul>
<li><a href="https://github.com/dddpaul/docker-nginx">dddpaul/docker-nginx</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module</a></li>
<li><a href="http://ittner.github.io/lua-iconv/">Lua iconv</a></li>
</ul>

<h2 id="java-hackish-way:9095423fd9c5e41ee9033ec52da6bac6">Java hackish way</h2>

<p>The idea is the same — url-decode GET-request values, convert to proper encoding and url-encode. At this time it&rsquo;s achieved by using private API of <a href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/coyote/Request.html">org.apache.coyote.Request</a> class to decode query string conditionally.</p>

<p>Implementation is quite simple as you can see from <a href="https://github.com/dddpaul/spring-boot-filters/blob/master/src/main/java/com/github/dddpaul/filters/Application.java">Spring Boot Filters application</a>.</p>

<p>URIs are re-encoded in servlet filter:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">CoyoteRequestManipulator</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Field</span> <span class="nf">getField</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
                                    <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasText</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;%&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">RequestFacade</span> <span class="n">facade</span> <span class="o">=</span> <span class="o">(</span><span class="n">RequestFacade</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// First hack is to get org.apache.coyote.Request instance</span>
                <span class="n">Field</span> <span class="n">requestField</span> <span class="o">=</span> <span class="n">getField</span><span class="o">(</span><span class="n">RequestFacade</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;request&quot;</span><span class="o">);</span>
                <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">Request</span> <span class="n">connRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">facade</span><span class="o">);</span>
                <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">coyote</span><span class="o">.</span><span class="na">Request</span> <span class="n">coyoteRequest</span> <span class="o">=</span> <span class="n">connRequest</span><span class="o">.</span><span class="na">getCoyoteRequest</span><span class="o">();</span>

                <span class="c1">// But it&#39;s already filled with decoded query parameters, so query string has</span>
                <span class="c1">// to be re-handled after URI encoding switch. So, in fact, query string is</span>
                <span class="c1">// processed twice. Yet, org.apache.coyote.Request instances are reusable,</span>
                <span class="c1">// so query encoding has to set every time.</span>
                <span class="n">Parameters</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">coyoteRequest</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
                <span class="n">parameters</span><span class="o">.</span><span class="na">setQueryStringEncoding</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getServletPath</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;/two&quot;</span><span class="o">)</span>
                        <span class="o">?</span> <span class="s">&quot;cp1251&quot;</span> <span class="o">:</span> <span class="s">&quot;utf-8&quot;</span><span class="o">);</span>
                <span class="n">parameters</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="n">parameters</span><span class="o">.</span><span class="na">handleQueryParameters</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
</p>

<p>Pros:</p>

<ul>
<li>no multiple connectors, listen on single port;</li>
<li>no recompiled Nginx stuff - just Java;</li>
<li>controller unit tests are passed;</li>
<li>integration tests are passed.
<br /></li>
</ul>

<p>Cons:</p>

<ul>
<li>reflection and private API usage :)</li>
<li>query string could be handled twice.</li>
</ul>

<p>Links:</p>

<ul>
<li><a href="https://github.com/dddpaul/spring-boot-filters">Spring Boot filter examples</a></li>
</ul>

<h2 id="the-other-way:9095423fd9c5e41ee9033ec52da6bac6">The other way</h2>

<p>Use the microservices, Luke! But for their simplicity and scalability you have pay with massive infrastructure changes. See the following articles for consideration:</p>

<ul>
<li><a href="http://www.kennybastani.com/2015/07/spring-cloud-docker-microservices.html">Building Microservices with Spring Cloud and Docker</a></li>
<li><a href="http://technologyconversations.com/2015/07/02/scaling-to-infinity-with-docker-swarm-docker-compose-and-consul-part-14-a-taste-of-what-is-to-come/">Scaling To Infinity with Docker Swarm, Docker Compose and Consul</a></li>
<li><a href="http://technologyconversations.com/2015/11/25/deploying-containers-with-docker-swarm-and-docker-networking/">Deploying Containers with Docker Swarm and Docker Networking</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/11/30/ansible-default-and-bool-filters/">
                    Ansible: &#34;default&#34; and &#34;bool&#34; filters
                </a>
            </h1>

            <span class="post-date">2015-11-30</span>

            

<p>There are plenty of <code>bool</code> and <code>default</code> filters usage in Ansible playbooks and templates. For example, in <a href="https://github.com/debops/ansible-docker/blob/master/tasks/main.yml">debops/ansible-docker</a>: <code>when: docker_upstream| d() | bool</code>.</p>

<p>Where <code>docker_upstream</code> is an YAML boolean: <code>docker_upstream: False</code>. It seems like &ldquo;when&rdquo; condition is <a href="https://dddpaul.github.io/blog/2015/11/29/ansible-defined-keyword/">overbloated again</a> :)</p>

<p>The <code>var | d() | bool</code> construction is spread all over the place, for example, in <a href="https://github.com/debops/ansible-docker/blob/master/templates/etc/default/docker.j2">docker config template</a>:</p>

<pre><code>{% if docker_listen | d() | bool %}
</code></pre>

<p>Where <code>docker_listen</code> is an YAML list: <code>docker_listen: [ '{{ docker_tcp_listen }}' ]</code>.</p>

<p>Is there a more simpler way to express things? Maybe <code>when: docker_upstream</code> or <code>%{ if docker_listen %}</code> will be enough?</p>

<hr />

<p>First of all, <code>d</code> is an alias for <code>default</code>, and <code>default</code> filter is defined in <a href="https://github.com/mitsuhiko/jinja2/blob/master/jinja2/filters.py">jinja2/filters.py</a>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_default</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If the value is undefined it will return the passed default value,</span>
<span class="sd">    otherwise the value of the variable:</span>

<span class="sd">    .. sourcecode:: jinja</span>

<span class="sd">        {{ my_variable|default(&#39;my_variable is not defined&#39;) }}</span>

<span class="sd">    This will output the value of ``my_variable`` if the variable was</span>
<span class="sd">    defined, otherwise ``&#39;my_variable is not defined&#39;``. If you want</span>
<span class="sd">    to use default with variables that evaluate to false you have to</span>
<span class="sd">    set the second parameter to `true`:</span>

<span class="sd">    .. sourcecode:: jinja</span>

<span class="sd">        {{ &#39;&#39;|default(&#39;the string was empty&#39;, true) }}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">boolean</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">default_value</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>


<p>So, the default &ldquo;default value&rdquo; is an empty string.</p>

<h3 id="var-d-test:df8aec350edd46b4d7f3e3e66fee95bc">&ldquo;var | d()&rdquo; test</h3>

<p>With <code>default</code> filter:
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{{ var | d() }}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
                                  <span class="c"># An empty string</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                                  <span class="c"># An empty string</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
<span class="n">abc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                                  <span class="c"># A space</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
<span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>
<span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">}</span>
</code></pre></div>
</p>

<p>Without <code>default</code> filter:
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{{ var }}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
                                  <span class="c"># An empty string</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                                  <span class="c"># An empty string</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
<span class="n">abc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                                  <span class="c"># A space</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
<span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>
<span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">}</span>
</code></pre></div>
</p>

<p>Pretty same, eh?</p>

<h3 id="str-d-bool-test:df8aec350edd46b4d7f3e3e66fee95bc">&ldquo;str | d() | bool&rdquo; test</h3>

<p>With <code>default</code> filter:
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">ansible.runner.filter_plugins.core</span> <span class="kn">import</span> <span class="nb">bool</span>
<span class="n">Template</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s">&#39;bool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{{ var | d() | bool }}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;True&#39;</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>
<span class="bp">False</span>
</code></pre></div>
</p>

<p>Without <code>default</code> filter:
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">ansible.runner.filter_plugins.core</span> <span class="kn">import</span> <span class="nb">bool</span>
<span class="n">Template</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s">&#39;bool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{{ var | bool }}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;True&#39;</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>
<span class="bp">False</span>
</code></pre></div>
</p>

<p>Pretty same again. So, it seems that <code>default()</code> or <code>d()</code> usage in conditions has no sense at all.</p>

<p>There are two specific features:</p>

<ol>
<li>When using undefined variables in actual Ansible playbooks without <code>default</code> filter <code>AnsibleUndefinedVariable</code> will be thrown. <strong>So finally, you have to use <code>default</code> filter to be safe.</strong></li>
<li>Also, mention that <code>bool</code> filter for empty and non-empty lists and dicts evaluates to <code>False</code>. It&rsquo;s followed from sources (see below).</li>
</ol>

<hr />

<p>Therefore, what about <code>bool</code> filter?</p>

<p>Remember <code>when: docker_upstream | d() | bool</code>, where <code>docker_upstream</code> is an YAML boolean.</p>

<p>Or <code>{% if docker_listen | d() | bool %}</code>, where <code>docker_listen</code> is an YAML list.</p>

<p>The <code>bool</code> filter is the part of <a href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/filter/core.py">Ansible plugins</a>:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">bool</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; return a bool for the arg &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div>
</p>

<p>You can clearly see from <code>bool</code> function implementation that <code>{% if docker_listen | d() | bool %}</code> results in <code>True</code> only if <code>docker_listen: True</code>. If <code>docker_listen</code> is an arbitrary string or a list (as expected) <code>{% if docker_listen | d() | bool %}</code> results in <code>False</code> always.</p>

<p>Therefore <code>{% if docker_listen | d() %}</code> gives us a correct behaviour for strings, lists and dictionaries (mappings). The reason is explained <a href="https://dddpaul.github.io/blog/2015/11/29/ansible-defined-keyword/">here</a> (see &ldquo;Secondly&rdquo;, &ldquo;Third&rdquo; and &ldquo;More detailed&rdquo; quotes):</p>

<blockquote>
<p>The if statement in Jinja is comparable with the Python if statement. In the simplest form, you can use it to test if <strong>a variable is defined, not empty or not false</strong>.</p>

<p>For sequences, (strings, lists, tuples), use the fact that <strong>empty sequences are false</strong>.</p>

<p>The following values are considered false: any empty mapping, for example, <code>{}</code>.</p>
</blockquote>

<p>But for booleans you have to use <code>bool</code> filter — <code>when: docker_upstream | d() | bool</code>, because <code>when: docker_upstream | d()</code> results in <code>True</code> even if <code>docker_upstream</code> is <code>False</code>.</p>

<p>Links:</p>

<ul>
<li><a href="https://github.com/debops/ansible-docker/pull/2">No need to evaluate a variable two times</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/11/29/ansible-defined-keyword/">
                    Ansible: &#34;defined&#34; keyword
                </a>
            </h1>

            <span class="post-date">2015-11-29</span>

            <p>Some hidden knowledge for the start:</p>

<p>First of all, the Ansible <code>when</code> clause contains a Jinja2 expression (see <a href="http://docs.ansible.com/ansible/playbooks_conditionals.html">Ansible playbook conditionals</a>). It&rsquo;s confirmed with a quote from <a href="http://shop.oreilly.com/product/0636920035626.do">Ansible: Up And Running</a>, page 41:</p>

<blockquote>
<p>Ansible also uses the <strong>Jinja2 template engine</strong> to evaluate variables in playbooks.</p>
</blockquote>

<p>Secondly, that how <a href="http://jinja.pocoo.org/docs/dev/templates/">Jinja2</a> interprets the <code>if</code> condition:</p>

<blockquote>
<p>The if statement in Jinja is comparable with the Python if statement. In the simplest form, you can use it to test if <strong>a variable is defined, not empty or not false</strong>.</p>
</blockquote>

<p>Third, a bit of truth about <a href="https://www.python.org/dev/peps/pep-0008/">Python</a>:</p>

<blockquote>
<p>For sequences, (strings, lists, tuples), use the fact that <strong>empty sequences are false</strong>.</p>
</blockquote>

<p>More detailed — <a href="https://docs.python.org/2/library/stdtypes.html">5.1. Truth Value Testing</a>:</p>

<blockquote>
<p>Any object can be tested for truth value, for use in an if or while condition or as operand of the Boolean operations below. The following values are considered false:</p>

<ul>
<li><code>None</code></li>
<li><code>False</code></li>
<li>zero of any numeric type, for example, <code>0</code>, <code>0L</code>, <code>0.0</code>, <code>0j</code></li>
<li>any empty sequence, for example, <code>''</code>, <code>()</code>, <code>[]</code></li>
<li>any empty mapping, for example, <code>{}</code></li>
<li>instances of user-defined classes, if the class defines a <code>__nonzero__()</code> or <code>__len__()</code> method, when that method returns the integer zero or bool value False.</li>
</ul>

<p>All other values are considered true — so objects of many types are always true.</p>

<p>Operations and built-in functions that have a Boolean result always return 0 or False for false and 1 or True for true, unless otherwise stated. (Important exception: the Boolean operations or and and always return one of their operands.)</p>
</blockquote>

<p>At last, a quote from <a href="http://shop.oreilly.com/product/0636920035626.do">Ansible: Up And Running</a>, page 23:</p>

<blockquote>
<p>Ansible is pretty flexible on how you represent truthy and falsey values in playbooks. Strictly speaking, module arguments (like <code>update_cache=yes</code>) are treated differently from values elsewhere in playbooks (like <code>sudo: True</code>). Values elsewhere are handled by the YAML parser and so use the YAML conventions of truthiness, which are:</p>

<p><em>YAML truthy:</em> true, True, TRUE, yes, Yes, YES, on, On, ON, y, Y</p>

<p><em>YAML falsey:</em> false, False, FALSE, no, No, NO, off, Off, OFF, n, N</p>

<p>Module arguments are passed as strings and use Ansible’s internal conventions, which are:</p>

<p><em>module arg truthy:</em> yes, on, 1, true</p>

<p><em>module arg falsey:</em> no, off, 0, false</p>
</blockquote>

<p>Why all of these are important? Because there are plenty of redundant <code>if</code> and <code>when</code> conditionals usage in Ansible playbooks and templates. For example in <a href="https://github.com/debops/ansible-nginx/blob/master/tasks/main.yml">debops/ansible-nginx</a>:</p>

<pre><code>- name: Manage local server definitions - create symlinks
  file:
    src: '/etc/nginx/sites-local/{{ item.0 }}'
    path: '/etc/nginx/sites-enabled/{{ item.1 }}'
    state: 'link'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_together:
    - '{{ nginx_local_servers.values() }}'
    - '{{ nginx_local_servers.keys() }}'
  notify: [ 'Test nginx and reload' ]
  when: ((nginx_local_servers is defined and nginx_local_servers) and
         (item.0 is defined and item.0))
</code></pre>

<p>See that overbloated <code>when</code> condition? Wouldn&rsquo;t be that simpler with <code>when: nginx_local_servers and item.0</code>?</p>

<p>Though it&rsquo;s not a complete equivalent because it evaluates to False when nginx_local_servers <strong>is defined and empty</strong>. But it&rsquo;s definitely correct behaviour — surely we have no usage for the empty servers string.</p>

<p>It&rsquo;s all just mere words without proper testing, so let&rsquo;s test long version <code>var is defined and var</code>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">% i</span><span class="s">f var is defined and var %} True {</span><span class="si">% e</span><span class="s">lse %} False {</span><span class="si">% e</span><span class="s">ndif %}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>                                                                                                                                                                                                                                           
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>                                                                                                                                                                                                                                           
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>                                                                                                                                                                                                                             
 <span class="bp">True</span> 
</code></pre></div>


<p>And the short version — <code>var</code>:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">% i</span><span class="s">f var %} True {</span><span class="si">% e</span><span class="s">lse %} False {</span><span class="si">% e</span><span class="s">ndif %}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[])</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">])</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{})</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">})</span>
 <span class="bp">True</span> 
</code></pre></div>
</p>

<p>So there are no differences at all. For the sake of thrust, let&rsquo;s test <code>var is defined</code>:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">tmpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">% i</span><span class="s">f var is defined %} True {</span><span class="si">% e</span><span class="s">lse %} False {</span><span class="si">% e</span><span class="s">ndif %}&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
 <span class="bp">False</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
 <span class="bp">True</span> 
</code></pre></div>
</p>

<p>So just use <code>var</code> and not <code>var is defined and var</code>, Luke!</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/07/28/firewalld-zones/">
                    Bind interfaces to multiple zones with Firewalld on CentOS-7
                </a>
            </h1>

            <span class="post-date">2015-07-28</span>

            <p>As you can expect from <a href="http://linuxmanpages.net/manpages/fedora20/man1/firewall-cmd.1.html">man firewall-cmd</a> interface binding to zone other than default (public) could be achieved with the following command sequence:</p>

<pre><code>firewall-cmd --zone public --remove-interface eth1 --permanent
firewall-cmd --zone internal --add-interface eth1 --permanent
firewall-cmd --reload
</code></pre>

<p>Seems like it&rsquo;s done:</p>

<pre><code>firewall-cmd --get-zone-of-interface=eth1
internal
</code></pre>

<p>But after firewalld restart or server reboot things aren&rsquo;t so bright:</p>

<pre><code>firewall-cmd --get-zone-of-interface=eth1
public
</code></pre>

<p>The reason is in this <a href="https://bugs.centos.org/view.php?id=7526">CentOS-7 bug</a>. The only workaround is to specify zone in <em>/etc/sysconfig/network-scripts/ifcfg-eth1</em> file:</p>

<pre><code>TYPE=Ethernet
NAME=&quot;eth1&quot;
IPADDR=x.x.x.x
...
ZONE=internal
</code></pre>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/07/12/spring-boot-value/">
                    Тонкости использования аннотации @Value в Spring Boot
                </a>
            </h1>

            <span class="post-date">2015-07-12</span>

            <p>Аннотация <a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Value.html">@Value</a> - это самый простой способ для &ldquo;впрыскивания&rdquo; значений из конфигурации Spring Boot в код. При этом также можно задать значение по-умолчанию.</p>

<p>Однако, стоит учитывать, что резолвинг значения будет выполняться для каждой аннотации @Value. Например, если аннотировать @Value два поля (в одном или разных классах - не суть важно) вот так:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param1</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param2</span><span class="o">;</span>
</code></pre></div>


<p>, то в debug-логе мы увидим:</p>

<pre><code>TRACE 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : getProperty(&quot;unique-param&quot;, String)
DEBUG 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : Searching for key 'unique-param' in [environmentProperties]
...
TRACE 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : getProperty(&quot;unique-param&quot;, String)
DEBUG 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : Searching for key 'unique-param' in [environmentProperties]
...
</code></pre>

<p>Т.е. поиск (резолвинг) был проведен дважды. Конечно, это слишком мизерная операция, чтобы хоть как-то замедлить старт приложения, но знать об этом стоит.</p>

<hr />

<p>Еще более неоднозначная штука связана с передачей дефолтного значения через @Value.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param:DefaultValue}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param</span><span class="o">;</span>
</code></pre></div>


<p>При резолвинге значения будет сначала проведен поиск параметра &ldquo;unique-param:DefaultValue&rdquo;, а уже потом - &ldquo;unique-param&rdquo;. Таким образом, если в конфигурации указать:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="na">unique-param\:DefaultValue</span> <span class="o">=</span> <span class="s">Another value</span>
</code></pre></div>


<p>, то param в коде будет равен &ldquo;Another value&rdquo;.</p>

<p>Такая логика прописана в org.springframework.util.PropertyPlaceholderHelper#parseStringValue.</p>

<hr />

<p>Оба этих нюанса могут ответить на вопрос - почему debug-лог приложения на Spring Boot такой большой.</p>

<p>Мораль - используйте <a href="http://docs.spring.io/autorepo/docs/spring-boot/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html">ConfigurationProperties</a>, что, в конце-концов, и советуется в <a href="http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">23. Externalized Configuration</a>, раздел &ldquo;23.7 Typesafe Configuration Properties&rdquo;.</p>

<p>Например:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;params&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">uniqueParam</span> <span class="o">=</span> <span class="s">&quot;Default value&quot;</span><span class="o">;</span>

    <span class="c1">// Getters are mandatory. Setters are mandatory for immutable types (such as String).</span>
 <span class="o">}</span>
</code></pre></div>
</p>

<p>Конфигурация:</p>

<p><div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="na">params.unique-param</span> <span class="o">=</span> <span class="s">Another value</span>
</code></pre></div>
</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="https://dddpaul.github.io/blog/2015/06/30/tomcat-http-logging/">
                    Логирование HTTP-запросов в Tomcat
                </a>
            </h1>

            <span class="post-date">2015-06-30</span>

            

<h2 id="apache-tomcat-request-dumper-filter:e82678ac23d6d6c6d716963b71ef486f">Apache Tomcat Request Dumper Filter</h2>

<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#Request_Dumper_Filter">Request Dumper Filter</a> входит в состав Tomcat. Рассмотрим способы его конфигурации.</p>

<h3 id="spring-boot:e82678ac23d6d6c6d716963b71ef486f">Spring Boot</h3>

<p>Достаточно поместить вот такой bean в класс, аннотированный @Configuration:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">RequestDumperFilter</span> <span class="nf">requestDumper</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RequestDumperFilter</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>


<p>Вывод дампа запросов в отдельный лог здесь не рассматриваем.</p>

<h3 id="tomcat-7:e82678ac23d6d6c6d716963b71ef486f">Tomcat 7</h3>

<p>Стандартный способ конфигурации фильтра — server.xml / context.xml / web.xml, в зависимости от того, какой scope нам нужен. Для логирования запросов в рамках одного приложения — web.xml.</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>RequestDumper<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.apache.catalina.filters.RequestDumperFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>

<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>RequestDumper<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</code></pre></div>


<p>Для логирования в отдельный файл нужно сконфигурировать <a href="https://tomcat.apache.org/tomcat-7.0-doc/logging.html">Tomcat JULI</a>. По-идее, можно логировать через Apache Commons Logging, но в доке дается пример для JULI. Поэтому, вот такой logging.properties можно смело кидать в webapp/WEB-INF/classes:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="c1"># Uncomment to dump HTTP request data, see http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#Request_Dumper_Filter</span>
<span class="c1">#handlers = 1request-dumper.org.apache.juli.FileHandler</span>

<span class="c1"># To this configuration below, 1request-dumper.org.apache.juli.FileHandler</span>
<span class="c1"># also needs to be added to the handlers property near the top of the file</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.level</span> <span class="o">=</span> <span class="s">INFO</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.directory</span> <span class="o">=</span> <span class="s">${catalina.base}/logs</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.prefix</span> <span class="o">=</span> <span class="s">request-dumper.</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.formatter</span> <span class="o">=</span> <span class="s">org.apache.juli.VerbatimFormatter</span>
<span class="na">org.apache.catalina.filters.RequestDumperFilter.level</span> <span class="o">=</span> <span class="s">INFO</span>
<span class="na">org.apache.catalina.filters.RequestDumperFilter.handlers</span> <span class="o">=</span> <span class="s">1request-dumper.org.apache.juli.FileHandler</span>
</code></pre></div>


<p>Получился почти production-ready вариант, для включения логирования можно раскомментировать строчку с handlers и перезапустить приложение. Совсем по-хорошему это нужно сделать через JMX, тогда, быть может, получится избежать перезапуска приложения.</p>

<h3 id="tomcat-5:e82678ac23d6d6c6d716963b71ef486f">Tomcat 5</h3>

<p>Для старого Томката нужно использовать <a href="https://tomcat.apache.org/tomcat-5.5-doc/config/valve.html#Request_Dumper_Valve">Request_Dumper_Valve</a>. Фильтра в базовой поставке еще нет, его нужно отдельно собирать из servlet-examples.</p>

<p>Для включения дампа нужно просто вставить строчку в server.xml (в блоки Engine или Host) и перезапустить сервер Tomcat:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;org.apache.catalina.valves.RequestDumperValve&quot;</span><span class="nt">/&gt;</span>
</code></pre></div>


<p>В первом случае (Engine) дамп будет выдаваться в catalina.out, а во втором (Host) - в localhost.log.</p>

<hr />

<p>У Request Dumper Filter есть два недостатка:</p>

<ul>
<li>нельзя залогировать тело запроса, только GET- и POST-параметры;</li>
<li>нет возможности логировать HTTP-ответы сервера.</li>
</ul>

<h2 id="кастомные-фильтры:e82678ac23d6d6c6d716963b71ef486f">Кастомные фильтры</h2>

<p>Основная проблема логирования тела запроса — это то, что body из <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletRequest.html">ServletRequest</a> достается из InputStream, т.е. это одноразовая операция. Мы не можем сначала где-то в фильтре прочитать body, залогировать, а потом второй раз прочитать body в обработчике запроса в приложении. В этом случае выскочит что-то вроде &ldquo;java.io.IOException: Attempted read on closed stream&rdquo;.</p>

<p>Различные кастомные способы обходят эту проблему, используя wrapper&rsquo;ы или декораторы. Т.е. в фильтре мы читаем body из ServletRequest в String-поле wrapper&rsquo;а, и далее по цепочке передаем уже wrapper. Метод же getInputStream() создает stream из этого String-поля wrapper&rsquo;а.</p>

<p>Есть две большие статьи с кусками почти работающего кода, реализующего этот подход:</p>

<ul>
<li><a href="http://natch3z.blogspot.co.uk/2009/01/read-request-body-in-filter.html">Read Request Body in Filter</a></li>
<li><a href="http://wetfeetblog.com/servlet-filer-to-log-request-and-response-details-and-payload/431">Servlet Filer to Log Request and Response Payload</a></li>
</ul>

<p>Также есть маленький, но многообещающий проект <a href="https://github.com/isrsal/spring-mvc-logger">spring-mvc-logger</a>, заточенный под Spring MVC (он использует его logging filters). Его я, к сожалению, не смотрел.</p>

<h2 id="logback-access:e82678ac23d6d6c6d716963b71ef486f">Logback-access</h2>

<p>100% работающий способ логировать HTTP-ответы и запросы. Это <a href="http://logback.qos.ch/access.html">Logback-access</a>, часть проекта Logback. Подробнее см. <a href="http://logback.qos.ch/recipes/captureHttp.html">Capturing HTTP requests and responses</a>.</p>

<p>Для выборочного отключения логирования (например, для тестовых или мониторинговых платежей) используется библиотека <a href="http://janino.net/changelog.html">Janino</a>. С ее помощью можно задать для logback-access фильтры (правила), которым должен соответствовать логируемый HTTP-пакет.</p>

<p>Однако, весь набор библиотек:</p>

<ul>
<li>logback-access.jar + logback-core.jar as dependency,</li>
<li>janino.jar + commons-compiler.jar as dependency,</li>
</ul>

<p>должен лежать в $TOMCAT_HOME/lib/.</p>

<p>Конфигурация logback-access.xml кладется в $TOMCAT_HOME/conf/:</p>

<p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!-- Tomcat&#39;s lib folder must contain logback-core.jar and logback-access.jar to dump HTTP requests and responses --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;DUMPER&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- Tomcat&#39;s lib folder must contain janino.jar and commons-compiler.jar to filter which HTTP requests and responses to dump --&gt;</span>
        <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;evaluator&gt;</span>
                <span class="c">&lt;!-- Disable dumping for HTTP requests for all apps except specified one and for requests with specific header --&gt;</span>
                <span class="c">&lt;!-- Responses to these requests will not be dumped too --&gt;</span>
                <span class="nt">&lt;expression&gt;</span>!event.getRequestURI().startsWith(&quot;/webapp&quot;) || event.getRequestHeader(&quot;X-Logging-Disabled&quot;).equals(&quot;true&quot;)<span class="nt">&lt;/expression&gt;</span>
            <span class="nt">&lt;/evaluator&gt;</span>
            <span class="nt">&lt;onMismatch&gt;</span>NEUTRAL<span class="nt">&lt;/onMismatch&gt;</span>
            <span class="nt">&lt;onMatch&gt;</span>DENY<span class="nt">&lt;/onMatch&gt;</span>
        <span class="nt">&lt;/filter&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>
                %date{yyyy-MM-dd HH:mm:ss.SSS} REQUEST: %fullRequest%n%n%date{yyyy-MM-dd HH:mm:ss.SSS} RESPONSE: %fullResponse
            <span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
        <span class="nt">&lt;file&gt;</span>${catalina.base}/logs/dumper.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>${catalina.base}/logs/dumper.%d.%i.log<span class="nt">&lt;/fileNamePattern&gt;</span>
            <span class="nt">&lt;timeBasedFileNamingAndTriggeringPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;maxFileSize&gt;</span>10MB<span class="nt">&lt;/maxFileSize&gt;</span>
            <span class="nt">&lt;/timeBasedFileNamingAndTriggeringPolicy&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;DUMPER&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div>
</p>

<p>Эта конфигурация устанавливает логирование всех HTTP-запросов на /webapp без HTTP-заголовка X-Logging-Disabled.</p>

<p>Также, должен быть активирован LogbackAccessValve в $TOMCAT_HOME/conf/server.xml (в блоке Host):</p>

<p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;ch.qos.logback.access.tomcat.LogbackValve&quot;</span><span class="nt">/&gt;</span>
</code></pre></div>
</p>

<p>Последний штрих — объявление фильтра <a href="http://logback.qos.ch/apidocs/ch/qos/logback/access/servlet/TeeFilter.html">TeeFilter</a>. В Spring Boot это делается элементарно:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * Enable HTTP response logging, see &lt;a href=&quot;http://logback.qos.ch/recipes/captureHttp.html&quot;&gt;Capturing HTTP requests and responses&lt;/a&gt;.</span>
<span class="cm"> * Tomcat&#39;s lib folder must contain logback-core.jar and logback-access.jar.</span>
<span class="cm"> */</span>
<span class="nd">@Bean</span>
<span class="n">Filter</span> <span class="nf">httpRequestAndResponseDumper</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TeeFilter</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>
</p>

        </div>
        
    </div>


<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter34067830 = new Ya.Metrika({
                    id:34067830,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/34067830" style="position:absolute; left:-9999px;" alt="" /></div></noscript>



</body>
</html>
