<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Dev notes &middot; Dev notes </title>

  
  <link rel="stylesheet" href="http://dddpaul.github.io/blog//css/poole.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog//css/syntax.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog//css/hyde.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://dddpaul.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="Dev notes" />

</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Dev notes</h1>
            <p class="lead">
                 Notes about Android, Java, JavaScript, Go and other technical stuff 
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="http://google.com/&#43;PavelDerendyaev1"> Google&#43; </a></li>
            
            <li><a href="index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="http://dddpaul.github.io/blog//tags/android">android</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/angularjs">angularjs</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/devops">devops</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/docker">docker</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/git">git</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/golang">golang</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/hugo">hugo</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/java">java</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/javascript">javascript</a> </li>
            
            <li><a href="http://dddpaul.github.io/blog//tags/linux">linux</a> </li>
            
        </ul>

        <p>&copy; 2015. All rights reserved. </p>
    </div>
</div>


<div class="content container">
    <div class="posts">

        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/07/12/spring-boot-value/">
                    Тонкости использования аннотации @Value в Spring Boot
                </a>
            </h1>

            <span class="post-date">2015-07-12</span>

            <p>Аннотация <a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Value.html">@Value</a> - это самый простой способ для &ldquo;впрыскивания&rdquo; значений из конфигурации Spring Boot в код. При этом также можно задать значение по-умолчанию.</p>

<p>Однако, стоит учитывать, что резолвинг значения будет выполняться для каждой аннотации @Value. Например, если аннотировать @Value два поля (в одном или разных классах - не суть важно) вот так:</p>

<p><div class="highlight"><pre><span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param1</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param2</span><span class="o">;</span>
</pre></div>
</p>

<p>, то в debug-логе мы увидим:</p>

<pre><code>TRACE 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : getProperty(&quot;unique-param&quot;, String)
DEBUG 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : Searching for key 'unique-param' in [environmentProperties]
...
TRACE 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : getProperty(&quot;unique-param&quot;, String)
DEBUG 23601 --- [lication.main()] o.s.c.e.PropertySourcesPropertyResolver  : Searching for key 'unique-param' in [environmentProperties]
...
</code></pre>

<p>Т.е. поиск (резолвинг) был проведен дважды. Конечно, это слишком мизерная операция, чтобы хоть как-то замедлить старт приложения, но знать об этом стоит.</p>

<hr />

<p>Еще более неоднозначная штука связана с передачей дефолтного значения через @Value.</p>

<p><div class="highlight"><pre><span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${unique-param:DefaultValue}&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">param</span><span class="o">;</span>
</pre></div>
</p>

<p>При резолвинге значения будет сначала проведен поиск параметра &ldquo;unique-param:DefaultValue&rdquo;, а уже потом - &ldquo;unique-param&rdquo;. Таким образом, если в конфигурации указать:</p>

<p><div class="highlight"><pre><span class="na">unique-param\:DefaultValue</span> <span class="o">=</span> <span class="s">Another value</span>
</pre></div>
</p>

<p>, то param в коде будет равен &ldquo;Another value&rdquo;.</p>

<p>Такая логика прописана в org.springframework.util.PropertyPlaceholderHelper#parseStringValue.</p>

<hr />

<p>Оба этих нюанса могут ответить на вопрос - почему debug-лог приложения на Spring Boot такой большой.</p>

<p>Мораль - используйте <a href="http://docs.spring.io/autorepo/docs/spring-boot/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html">ConfigurationProperties</a>, что, в конце-концов, и советуется в <a href="http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">23. Externalized Configuration</a>, раздел &ldquo;23.7 Typesafe Configuration Properties&rdquo;.</p>

<p>Например:</p>

<p><div class="highlight"><pre><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;params&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">uniqueParam</span> <span class="o">=</span> <span class="s">&quot;Default value&quot;</span><span class="o">;</span>

    <span class="c1">// Getters are mandatory. Setters are mandatory for immutable types (such as String).</span>
 <span class="o">}</span>
</pre></div>
</p>

<p>Конфигурация:</p>

<p><div class="highlight"><pre><span class="na">params.unique-param</span> <span class="o">=</span> <span class="s">Another value</span>
</pre></div>
</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/06/30/tomcat-http-logging/">
                    Логирование HTTP-запросов в Tomcat
                </a>
            </h1>

            <span class="post-date">2015-06-30</span>

            

<h2 id="apache-tomcat-request-dumper-filter:e82678ac23d6d6c6d716963b71ef486f">Apache Tomcat Request Dumper Filter</h2>

<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#Request_Dumper_Filter">Request Dumper Filter</a> входит в состав Tomcat. Рассмотрим способы его конфигурации.</p>

<h3 id="spring-boot:e82678ac23d6d6c6d716963b71ef486f">Spring Boot</h3>

<p>Достаточно поместить вот такой bean в класс, аннотированный @Configuration:</p>

<p><div class="highlight"><pre><span class="nd">@Bean</span>
<span class="n">RequestDumperFilter</span> <span class="nf">requestDumper</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RequestDumperFilter</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</p>

<p>Вывод дампа запросов в отдельный лог здесь не рассматриваем.</p>

<h3 id="tomcat-7:e82678ac23d6d6c6d716963b71ef486f">Tomcat 7</h3>

<p>Стандартный способ конфигурации фильтра — server.xml / context.xml / web.xml, в зависимости от того, какой scope нам нужен. Для логирования запросов в рамках одного приложения — web.xml.</p>

<p><div class="highlight"><pre><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>RequestDumper<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.apache.catalina.filters.RequestDumperFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>

<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>RequestDumper<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</p>

<p>Для логирования в отдельный файл нужно сконфигурировать <a href="https://tomcat.apache.org/tomcat-7.0-doc/logging.html">Tomcat JULI</a>. По-идее, можно логировать через Apache Commons Logging, но в доке дается пример для JULI. Поэтому, вот такой logging.properties можно смело кидать в webapp/WEB-INF/classes:</p>

<p><div class="highlight"><pre><span class="c1"># Uncomment to dump HTTP request data, see http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#Request_Dumper_Filter</span>
<span class="c1">#handlers = 1request-dumper.org.apache.juli.FileHandler</span>

<span class="c1"># To this configuration below, 1request-dumper.org.apache.juli.FileHandler</span>
<span class="c1"># also needs to be added to the handlers property near the top of the file</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.level</span> <span class="o">=</span> <span class="s">INFO</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.directory</span> <span class="o">=</span> <span class="s">${catalina.base}/logs</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.prefix</span> <span class="o">=</span> <span class="s">request-dumper.</span>
<span class="na">1request-dumper.org.apache.juli.FileHandler.formatter</span> <span class="o">=</span> <span class="s">org.apache.juli.VerbatimFormatter</span>
<span class="na">org.apache.catalina.filters.RequestDumperFilter.level</span> <span class="o">=</span> <span class="s">INFO</span>
<span class="na">org.apache.catalina.filters.RequestDumperFilter.handlers</span> <span class="o">=</span> <span class="s">1request-dumper.org.apache.juli.FileHandler</span>
</pre></div>
</p>

<p>Получился почти production-ready вариант, для включения логирования можно раскомментировать строчку с handlers и перезапустить приложение. Совсем по-хорошему это нужно сделать через JMX, тогда, быть может, получится избежать перезапуска приложения.</p>

<h3 id="tomcat-5:e82678ac23d6d6c6d716963b71ef486f">Tomcat 5</h3>

<p>Для старого Томката нужно использовать <a href="https://tomcat.apache.org/tomcat-5.5-doc/config/valve.html#Request_Dumper_Valve">Request_Dumper_Valve</a>. Фильтра в базовой поставке еще нет, его нужно отдельно собирать из servlet-examples.</p>

<p>Для включения дампа нужно просто вставить строчку в server.xml (в блоки Engine или Host) и перезапустить сервер Tomcat:</p>

<p><div class="highlight"><pre><span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;org.apache.catalina.valves.RequestDumperValve&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</p>

<p>В первом случае (Engine) дамп будет выдаваться в catalina.out, а во втором (Host) - в localhost.log.</p>

<hr />

<p>У Request Dumper Filter есть два недостатка:</p>

<ul>
<li>нельзя залогировать тело запроса, только GET- и POST-параметры;</li>
<li>нет возможности логировать HTTP-ответы сервера.</li>
</ul>

<h2 id="кастомные-фильтры:e82678ac23d6d6c6d716963b71ef486f">Кастомные фильтры</h2>

<p>Основная проблема логирования тела запроса — это то, что body из <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletRequest.html">ServletRequest</a> достается из InputStream, т.е. это одноразовая операция. Мы не можем сначала где-то в фильтре прочитать body, залогировать, а потом второй раз прочитать body в обработчике запроса в приложении. В этом случае выскочит что-то вроде &ldquo;java.io.IOException: Attempted read on closed stream&rdquo;.</p>

<p>Различные кастомные способы обходят эту проблему, используя wrapper&rsquo;ы или декораторы. Т.е. в фильтре мы читаем body из ServletRequest в String-поле wrapper&rsquo;а, и далее по цепочке передаем уже wrapper. Метод же getInputStream() создает stream из этого String-поля wrapper&rsquo;а.</p>

<p>Есть две большие статьи с кусками почти работающего кода, реализующего этот подход:</p>

<ul>
<li><a href="http://natch3z.blogspot.co.uk/2009/01/read-request-body-in-filter.html">Read Request Body in Filter</a></li>
<li><a href="http://wetfeetblog.com/servlet-filer-to-log-request-and-response-details-and-payload/431">Servlet Filer to Log Request and Response Payload</a></li>
</ul>

<p>Также есть маленький, но многообещающий проект <a href="https://github.com/isrsal/spring-mvc-logger">spring-mvc-logger</a>, заточенный под Spring MVC (он использует его logging filters). Его я, к сожалению, не смотрел.</p>

<h2 id="logback-access:e82678ac23d6d6c6d716963b71ef486f">Logback-access</h2>

<p>100% работающий способ логировать HTTP-ответы и запросы. Это <a href="http://logback.qos.ch/access.html">Logback-access</a>, часть проекта Logback. Подробнее см. <a href="http://logback.qos.ch/recipes/captureHttp.html">Capturing HTTP requests and responses</a>.</p>

<p>Для выборочного отключения логирования (например, для тестовых или мониторинговых платежей) используется библиотека <a href="http://janino.net/changelog.html">Janino</a>. С ее помощью можно задать для logback-access фильтры (правила), которым должен соответствовать логируемый HTTP-пакет.</p>

<p>Однако, весь набор библиотек:</p>

<ul>
<li>logback-access.jar + logback-core.jar as dependency,</li>
<li>janino.jar + commons-compiler.jar as dependency,</li>
</ul>

<p>должен лежать в $TOMCAT_HOME/lib/.</p>

<p>Конфигурация logback-access.xml кладется в $TOMCAT_HOME/conf/:</p>

<p><div class="highlight"><pre><span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!-- Tomcat&#39;s lib folder must contain logback-core.jar and logback-access.jar to dump HTTP requests and responses --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;DUMPER&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- Tomcat&#39;s lib folder must contain janino.jar and commons-compiler.jar to filter which HTTP requests and responses to dump --&gt;</span>
        <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;evaluator&gt;</span>
                <span class="c">&lt;!-- Disable dumping for HTTP requests for all apps except specified one and for requests with specific header --&gt;</span>
                <span class="c">&lt;!-- Responses to these requests will not be dumped too --&gt;</span>
                <span class="nt">&lt;expression&gt;</span>!event.getRequestURI().startsWith(&quot;/webapp&quot;) || event.getRequestHeader(&quot;X-Logging-Disabled&quot;).equals(&quot;true&quot;)<span class="nt">&lt;/expression&gt;</span>
            <span class="nt">&lt;/evaluator&gt;</span>
            <span class="nt">&lt;onMismatch&gt;</span>NEUTRAL<span class="nt">&lt;/onMismatch&gt;</span>
            <span class="nt">&lt;onMatch&gt;</span>DENY<span class="nt">&lt;/onMatch&gt;</span>
        <span class="nt">&lt;/filter&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>
                %date{yyyy-MM-dd HH:mm:ss.SSS} REQUEST: %fullRequest%n%n%date{yyyy-MM-dd HH:mm:ss.SSS} RESPONSE: %fullResponse
            <span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
        <span class="nt">&lt;file&gt;</span>${catalina.base}/logs/dumper.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>${catalina.base}/logs/dumper.%d.%i.log<span class="nt">&lt;/fileNamePattern&gt;</span>
            <span class="nt">&lt;timeBasedFileNamingAndTriggeringPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;maxFileSize&gt;</span>10MB<span class="nt">&lt;/maxFileSize&gt;</span>
            <span class="nt">&lt;/timeBasedFileNamingAndTriggeringPolicy&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;DUMPER&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</p>

<p>Эта конфигурация устанавливает логирование всех HTTP-запросов на /webapp без HTTP-заголовка X-Logging-Disabled.</p>

<p>Также, должен быть активирован LogbackAccessValve в $TOMCAT_HOME/conf/server.xml (в блоке Host):</p>

<p><div class="highlight"><pre><span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;ch.qos.logback.access.tomcat.LogbackValve&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</p>

<p>Последний штрих — объявление фильтра <a href="http://logback.qos.ch/apidocs/ch/qos/logback/access/servlet/TeeFilter.html">TeeFilter</a>. В Spring Boot это делается элементарно:</p>

<p><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Enable HTTP response logging, see &lt;a href=&quot;http://logback.qos.ch/recipes/captureHttp.html&quot;&gt;Capturing HTTP requests and responses&lt;/a&gt;.</span>
<span class="cm"> * Tomcat&#39;s lib folder must contain logback-core.jar and logback-access.jar.</span>
<span class="cm"> */</span>
<span class="nd">@Bean</span>
<span class="n">Filter</span> <span class="nf">httpRequestAndResponseDumper</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TeeFilter</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/05/15/rabbitmq-links/">
                    RabbitMQ links
                </a>
            </h1>

            <span class="post-date">2015-05-15</span>

            <p>RabbitMQ confirms, transactions, reply-to functionality and Spring integration:</p>

<ul>
<li><a href="http://docs.spring.io/spring-amqp/reference/html/amqp.html">Using Spring AMQP</a></li>
<li><a href="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/">Introducing Publisher Confirms</a></li>
<li><a href="https://kishanthan.wordpress.com/2013/05/05/transaction-support-with-rabbitmq/">Transaction support with RabbitMQ</a></li>
<li><a href="http://www.rabbitmq.com/confirms.html">Confirms (aka Publisher Acknowledgements)</a></li>
<li><a href="http://www.rabbitmq.com/direct-reply-to.html">Direct reply-to</a></li>
<li><a href="http://www.rabbitmq.com/tutorials/tutorial-six-java.html">Remote procedure call (RPC)</a></li>
<li><a href="https://gist.github.com/scvalex/613157">TxDontLoseMessages.java</a></li>
<li><a href="https://raw.githubusercontent.com/rabbitmq/rabbitmq-java-client/master/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java">ConfirmDontLoseMessages.java</a></li>
<li><a href="http://habrahabr.ru/post/262069/">RabbitMQ Spring tutorial</a> &amp; <a href="https://github.com/Dmitry-Shweikus/rabbitmq-examples">rabbitmq-examples</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/04/12/java-builders/">
                    Java builders
                </a>
            </h1>

            <span class="post-date">2015-04-12</span>

            <p>So it&rsquo;s time to scrutinize <a href="http://en.wikipedia.org/wiki/Builder_pattern">a builder pattern</a>. There are bunch of options to implement builder pattern in Java:</p>

<ul>
<li><a href="http://habrahabr.ru/post/86252/">classic</a> builder;</li>
<li><a href="http://habrahabr.ru/post/244521/">elegant</a> builder;</li>
<li>classic builder with <a href="https://github.com/analytically/innerbuilder">IntelliJ IDEA plugin</a>;</li>
<li><a href="https://github.com/google/auto/tree/master/value">Google AutoValue</a> builder;</li>
<li><a href="http://projectlombok.org/features/Builder.html">Project Lombok</a> builder;</li>
<li><a href="http://immutables.github.io/">Immutables</a> builder.</li>
</ul>

<p>All of these variants have been examined in <a href="https://github.com/dddpaul/java-builders">Java builders</a> GitHub project.</p>

<p>The winners are (and this a tough IMHO):</p>

<ul>
<li>IDEA InnerBuilder plugin if you use builder class from frameworks like <a href="http://spring.io/">Spring/Spring MVC</a> or <a href="https://www.playframework.com/">Play</a>. You can&rsquo;t pass validation annotations to generated class. Despite everything if there is a way to do this I&rsquo;ll be happy to mistake.</li>
<li>Immutables.org builder in all other cases. It&rsquo;s features rich and generates beautiful code.</li>
</ul>

<p>But do not forget about AutoValue because it&rsquo;s backed by Google itself.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/02/14/oracle-connectivity/">
                    Oracle connectivity in Java
                </a>
            </h1>

            <span class="post-date">2015-02-14</span>

            <p>A new small <a href="https://github.com/dddpaul/java-oracle-connectivity">test project</a> is intended to answer the question - what is the proper way to specify network timeout for database connection?</p>

<p>There so many ways in JDBC API:</p>

<ul>
<li><a href="http://docs.oracle.com/javase/7/docs/api/javax/sql/CommonDataSource.html#setLoginTimeout(int)">CommonDataSource.setLoginTimeout</a></li>
<li><a href="http://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#setNetworkTimeout(java.util.concurrent.Executor,%20int)">Connection.setNetworkTimeout</a></li>
<li><a href="http://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#setQueryTimeout(int)">Statement.setQueryTimeout</a></li>
</ul>

<p>And every database has it&rsquo;s own non-standard ways in addition.</p>

<p>But these tests have been lead us to a single conclusion — you must specify network timeouts on driver level. All these JDBC stuff isn&rsquo;t enough for Oracle database.</p>

<p>This code is suitable for <a href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">Tomcat JDBC Connection Pool</a>:</p>

<p><div class="highlight"><pre><span class="c1">// Get datasource some way</span>
<span class="n">Datasource</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">createDataSource</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>

<span class="c1">// Set connect (login) timeout</span>
<span class="n">ds</span><span class="o">.</span><span class="na">setConnectionProperties</span><span class="o">(</span><span class="n">OracleConnection</span><span class="o">.</span><span class="na">CONNECTION_PROPERTY_THIN_NET_CONNECT_TIMEOUT</span> <span class="o">+</span> <span class="s">&quot;=3000&quot;</span><span class="o">);</span>

<span class="c1">// Set common network read timeout</span>
<span class="n">ds</span><span class="o">.</span><span class="na">setConnectionProperties</span><span class="o">(</span><span class="n">OracleConnection</span><span class="o">.</span><span class="na">CONNECTION_PROPERTY_THIN_READ_TIMEOUT</span> <span class="o">+</span> <span class="s">&quot;=3000&quot;</span><span class="o">);</span>
</pre></div>
</p>

<p>The proper way to specify these timeouts in <a href="http://tomcat.apache.org/tomcat-7.0-doc/jndi-datasource-examples-howto.html">JNDI Datasource configuration</a>:</p>

<p><div class="highlight"><pre><span class="nt">&lt;Resource</span> <span class="na">name=</span><span class="s">&quot;jdbc/oracle&quot;</span>
    <span class="na">driverClassName=</span><span class="s">&quot;oracle.jdbc.OracleDriver&quot;</span>
    <span class="na">factory=</span><span class="s">&quot;org.apache.tomcat.jdbc.pool.DataSourceFactory&quot;</span>
    <span class="na">connectionProperties=</span><span class="s">&quot;oracle.net.CONNECT_TIMEOUT=3000;oracle.jdbc.ReadTimeout=3000&quot;</span>
    <span class="err">...</span>
    <span class="nt">/&gt;</span>
</pre></div>
</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/02/01/java-listeners/">
                    Java network listeners
                </a>
            </h1>

            <span class="post-date">2015-02-01</span>

            <p>I&rsquo;ve written a small <a href="https://github.com/dddpaul/java-network-listeners">listeners library</a> today. It allows to create Callables which can be submitted to <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a>. The callable itself implements creating server socket and binding it to local port.</p>

<p>There two principal type of listeners: blocking and non-blocking (thanks to <a href="http://en.wikipedia.org/wiki/Non-blocking_I/O_(Java">Java NIO</a>).</p>

<hr />

<p>Blocking listener is very simple but in can&rsquo;t be interrupted by calling thread. So there&rsquo;s no point in that:</p>

<p><div class="highlight"><pre><span class="n">Future</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span> <span class="n">Listeners</span><span class="o">.</span><span class="na">createListener</span><span class="o">(</span> <span class="n">PORT</span> <span class="o">)</span> <span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span> <span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span> <span class="n">TimeoutException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span>
<span class="o">}</span>
</pre></div>
</p>

<p>Listener will stay active and PORT will be bound still. The reason is in usage of the uninterruptible <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html#accept(">ServerSocket.accept()</a>).</p>

<hr />

<p>In contrary non-blocking listener is more sophisticated but it can be interrupted by calling thread. So you can do that:</p>

<p><div class="highlight"><pre><span class="n">Future</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span> <span class="n">Listeners</span><span class="o">.</span><span class="na">createListener</span><span class="o">(</span> <span class="n">PORT</span> <span class="o">)</span> <span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span> <span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span> <span class="n">TimeoutException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span>
<span class="o">}</span>
</pre></div>
</p>

<p>Listener will be terminated and PORT will be freed.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/17/memory-leaks-articles/">
                    List of memory leaks articles
                </a>
            </h1>

            <span class="post-date">2015-01-17</span>

            <p>&ldquo;Solving OutOfMemoryError&rdquo; series from Nikita Salnikov-Tarnovsky and Vladimir Šor:</p>

<ul>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-story-of-a-developer">Solving OutOfMemoryError (part 1) – story of a developer</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-why-didnt-operations-solve-it">Solving OutOfMemoryError (part 2) – why didn’t operations solve it?</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-where-do-you-start">Solving OutOfMemoryError (part 3) – where do you start?</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-memory-profilers">Solving OutOfMemoryError (part 4) – memory profilers</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-jdk-tools">Solving OutOfMemoryError (part 5) – JDK Tools</a></li>
<li><a href="https://plumbr.eu/blog/solving-outofmemoryerror-dump-is-not-a-waste">Solving OutOfMemoryError (part 6) – Dump is not a waste</a></li>
</ul>

<hr />

<p>&ldquo;Classloader leaks&rdquo; series from Mattias Jiderhamn:</p>

<ul>
<li><a href="http://java.jiderhamn.se/2011/12/11/classloader-leaks-i-how-to-find-classloader-leaks-with-eclipse-memory-analyser-mat/">Classloader leaks I – How to find classloader leaks with Eclipse Memory Analyser (MAT)</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/01/classloader-leaks-ii-find-and-work-around-unwanted-references/">Classloader leaks II – Find and work around unwanted references</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/15/classloader-leaks-iii-die-thread-die/">Classloader leaks III – “Die Thread, die!”</a></li>
<li><a href="http://java.jiderhamn.se/2012/01/29/classloader-leaks-iv-threadlocal-dangers-and-why-threadglobal-may-have-been-a-more-appropriate-name/">Classloader leaks IV – ThreadLocal dangers and why ThreadGlobal may have been a more appropriate name</a></li>
<li><a href="http://java.jiderhamn.se/2012/02/26/classloader-leaks-v-common-mistakes-and-known-offenders/">Classloader leaks V – Common mistakes and Known offenders</a></li>
<li><a href="http://java.jiderhamn.se/2012/03/04/classloader-leaks-vi-this-means-war-leak-prevention-library/">Classloader leaks VI – “This means war!” (leak prevention library)</a></li>
</ul>

<p>Object, class and classloader relationships are illustrated by this graph from <a href="https://plumbr.eu/blog/what-is-a-permgen-leak">What is a PermGen leak?</a> article.</p>

<p>
<img src='http://dddpaul.github.io/blog//media/object-class-classloader.png'/>
</p>

<hr />

<p>Tomcat specific articles:</p>

<ul>
<li><a href="http://java.dzone.com/articles/memory-leak-protection-tomcat">Memory Leak Protection in Tomcat 7</a></li>
<li><a href="http://wiki.apache.org/tomcat/MemoryLeakProtection">Tomcat Wiki - MemoryLeakProtection</a></li>
</ul>

<hr />

<p>Other articles:</p>

<ul>
<li><a href="https://plumbr.eu/blog/what-is-a-memory-leak">What is a memory leak?</a></li>
<li><a href="https://plumbr.eu/blog/what-is-a-permgen-leak">What is a PermGen leak?</a></li>
<li><a href="https://plumbr.eu/permgen">The Guide to Solving Permgen Leaks</a></li>
<li><a href="http://frankkieviet.blogspot.se/2006/10/classloader-leaks-dreaded-permgen-space.html">Classloader leaks: the dreaded &ldquo;java.lang.OutOfMemoryError: PermGen space&rdquo; exception</a></li>
</ul>

<hr />

<p>And the summary:</p>

<p><em>The memory leak is caused by objects that live longer than expected.</em></p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/12/docker-fig/">
                    Запуск контейнеров с помощью Fig
                </a>
            </h1>

            <span class="post-date">2015-01-12</span>

            

<p>Это третья статья цикла 
<a href='http://dddpaul.github.io/blog//series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>Как мы уже убедились, запуск контейнеров с помощью <code>docker run</code> — занятие весьма муторное, т.к. необходимо указывать множество опций. При запуске же нескольких контейнеров ситуация только ухудшается, т.к. теперь нужно задавать имена и линки.</p>

<p>Эту проблему решает инструмент <a href="http://www.fig.sh/">Fig</a>, который может запустить/остановить целое тестовое окружение, состоящее из набора контейнеров. Описание контейнеров задано в YAML-файле. Таким образом, этот YAML-файл представляет собой конфигурацию тестового окружения.</p>

<p>Конфигурация нашего тестового окружения <em>test-env/fig.yml</em>:</p>

<pre><code>app1:
  image: smile/app1
  ports: ['2021:22', '8081:80']
  privileged: true

app2:
  image: smile/app2
  ports: ['2022:22', '8082:80']
  privileged: true

gate:
  image: smile/gate
  links: [app1, app2]
  ports: ['2020:22', '80:80']
  privileged: true
</code></pre>

<p>Запуск тестового окружения (находясь в каталоге с файлом <em>fig.yml</em>): <code>fig up</code>.</p>

<p>По-умолчанию, Fig захватывает консоль и мультиплексирует вывод всех контейнеров. Для запуска в detached mode нужно использовать опцию <code>-d</code>. Посмотреть вывод контейнеров в этом режиме можно с помощью команды <code>fig logs</code>.</p>

<p>Статус тестового окружения: <code>fig ps</code>.</p>

<p>Остановка тестового окружения: <code>fig stop</code>.</p>

<h3 id="запуск-тестового-окружения-с-помощью-upstart:d4c1615d910942891ab8ffffd8a5f2e3">Запуск тестового окружения с помощью Upstart</h3>

<p>Job <em>/etc/init/fig-test-env.conf</em> создан на основе <a href="https://gist.github.com/HeyImAlex/9649374">HeyImAlex/fig.conf</a>. Для отключения автостарта нужно закомментировать вторую строчку (&ldquo;start on &hellip;&rdquo;).</p>

<pre><code>description &quot;Test environment runner&quot;
start on filesystem and started docker
stop on runlevel [!2345]
respawn
chdir /path/to/test-env
script
  # Wait for docker to finish starting up first.
  FILE=/var/run/docker.sock
  while [ ! -e $FILE ] ; do
    inotifywait -t 2 -e create $(dirname $FILE)
  done
  /usr/local/bin/fig up
end script
post-stop script
 /usr/local/bin/fig stop
end script
</code></pre>

<p>Теперь можно запустить тестовое окружение из любого места командой <code>start fig-test-env</code>, а остановить — <code>stop fig-test-env</code>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/08/docker-linking/">
                    Связывание контейнеров
                </a>
            </h1>

            <span class="post-date">2015-01-08</span>

            <p>Это вторая статья цикла 
<a href='http://dddpaul.github.io/blog//series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>При создании тестовых окружений из нескольких контейнеров неизбежно возникает задача их взаимного связывания. Набивший оскомину пример: контейнеру с приложением нужен контейнер БД. В нашем же случае, контейнеру с балансером нужны контейнеры с апстримами.</p>

<p>Статья <a href="https://docs.docker.com/userguide/dockerlinks/">Linking Containers Together</a> полностью раскрывает вопрос линковки контейнеров. Осветим вкратце лишь основные моменты:</p>

<ul>
<li>каждый контейнер необходимо как-то назвать с помощью опции <code>--name</code>;</li>
<li>ссылка на контейнер-зависимость обозначается опцией <code>--link</code>;</li>
<li>в итоге, внутри зависимого контейнера, инициализируется множество переменных окружения, содержащих параметры контейнера-зависимости, а также в <em>/etc/hosts</em> заносится IP-адрес контейнера-зависимости.</li>
</ul>

<p>Например, так выглядит последовательный запуск 3-х контейнеров, причем 3-й зависит от первых двух:</p>

<pre><code>docker run -d --privileged -p 2021:22 -p 8081:80 --name app1 smile/tomcat7
docker run -d --privileged -p 2022:22 -p 8082:80 --name app2 smile/tomcat7
docker run -d --privileged -p 2020:22 -p 80:80 --name gate --link app1:app1 --link app2:app2 smile/gate
</code></pre>

<p>Для проверки можно использовать вывод <code>docker inspect</code>:</p>

<pre><code>docker inspect -f &quot;{{ .HostConfig.Links }}&quot; gate

[/app1:/gate/app1 /app2:/gate/app2]
</code></pre>

<p>Опция <code>-d (detach mode)</code> здесь необходима, чтобы контейнеры запускались в фоновом режиме и не захватывали консоль.</p>

<p>Теперь, если зайти в контейнер gate (<code>ssh -p 2020 root@localhost</code>) и посмотреть переменные окружения, то будет ясно, что gate &ldquo;видит&rdquo; exposed-порты и IP-адрес контейнера-зависимости:</p>

<pre><code>root@aba982937531:~# env | grep APP1
APP1_NAME=/gate/app1
APP1_PORT_22_TCP=tcp://172.17.0.28:22
APP1_PORT_80_TCP=tcp://172.17.0.28:80
APP1_PORT_22_TCP_ADDR=172.17.0.28
APP1_PORT_80_TCP_ADDR=172.17.0.28
APP1_PORT_22_TCP_PORT=22
APP1_PORT_80_TCP_PORT=80
APP1_PORT_80_TCP_PROTO=tcp
APP1_PORT_22_TCP_PROTO=tcp
APP1_PORT=tcp://172.17.0.28:22
...
</code></pre>

<p>Еще лучше дела обстоят с <em>/etc/hosts</em>:</p>

<pre><code>root@aba982937531:~# grep app1 /etc/hosts
172.17.0.28	app1

</code></pre>

<p>Модификация <em>/etc/hosts</em>, например, дает возможность писать следующие кофиги Nginx:</p>

<pre><code>server {
    listen 80 default_server;
    server_name _;

    location /app1 {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #
        proxy_pass http://app1:80/app1;                              # app1 host here
        proxy_redirect http://127.0.0.1:8081/app1 /app1;             #
    }

    location /app2 {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #
        proxy_pass http://app2:80/app2;                              # and app2 host here
        proxy_redirect http://127.0.0.1:8082/app2 /app2;             #
    }
}
</code></pre>

<p>Таким образом, в первом приближении, встроенная возможность связывания контейнеров в Docker решает наши проблемы.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://dddpaul.github.io/blog/2015/01/04/docker-prepare/">
                    Подготовка и запуск docker-контейнеров
                </a>
            </h1>

            <span class="post-date">2015-01-04</span>

            

<p>Это первая статья цикла 
<a href='http://dddpaul.github.io/blog//series/building-test-environments-with-docker'>Building test environments with Docker</a>.</p>

<p>Сразу оговорюсь, что все docker-контейнеры основаны на <a href="http://phusion.github.io/baseimage-docker/">baseimage-docker</a>. Этот образ позволяет запускать в контейнере несколько приложений с помощью супервизора <a href="http://smarden.org/runit/">runit</a> и содержит ssh, cron, syslog &ldquo;из коробки&rdquo;.</p>

<p>Хотя подобный подход <a href="http://jpetazzo.github.io/2014/06/23/docker-ssh-considered-evil/">не рекомендуется разработчиками Docker</a>, он очень удобен в эксплуатации и не принуждает разработчика к своему &ldquo;proper way&rdquo;. Всегда можно использовать канонический подход от Docker с volumes и nsenter, а, при желании, подключаться к контейнерам по ssh.</p>

<p>Кроме того, я привык использовать сервера приложений в связке с nginx, и baseimage-docker позволяет легко это сделать.</p>

<h3 id="базовый-образ:4df06129fe4804053dfd65ac4e205d9e">Базовый образ</h3>

<p>При создании базового образа выполняются две вещи:</p>

<ul>
<li>публичный ssh-ключ добавляется в список разрешенных для суперпользователя контейнера;</li>
<li>задается локаль.</li>
</ul>

<p><em>Dockerfile</em> базового образа:</p>

<pre><code>FROM phusion/baseimage:0.9.15

# Add public SSH keys
ADD my_rsa_public_key /tmp/my_rsa_public_key
RUN cat /tmp/my_rsa_public_key &gt;&gt; /root/.ssh/authorized_keys &amp;&amp; rm -f /tmp/my_rsa_public_key

# Locale
ENV LANG=en_US.utf8

# Use baseimage-docker's init system
CMD [&quot;/sbin/my_init&quot;]
</code></pre>

<p>Свой публичный ssh-ключ, естественно, надо положить в <em>my_rsa_public_key</em> рядом с <em>Dockerfile</em>.</p>

<p>Сборка: <code>docker build -t smile/base .</code> и запуск:</p>

<pre><code>docker run --rm -it -p 2022:22 smile/base /sbin/my_init -- bash -l
</code></pre>

<p><code>--rm</code> используется для удаления контейнера после его остановки, <code>-it</code> — для терминального интеракивного режима, а <code>-- bash -l</code> — для запуска шелла после запуска всех сервисов.</p>

<p>Также на контейнер можно зайти по ssh: <code>ssh -p 2022 root@localhost</code>.</p>

<h3 id="образ-с-nginx:4df06129fe4804053dfd65ac4e205d9e">Образ с nginx</h3>

<p>Сборка <a href="https://github.com/dddpaul/docker-nginx">docker-nginx</a>: <code>docker build -t smile/nginx .</code></p>

<p>Основная особенность этого образа в том, что при запуске контейнера отключается IPv6.</p>

<p>Сделано это для того, чтобы обойти известную проблему с проксированием Nginx. Т.к. демон висит на tcp6, то апстрим иногда видит запрос от 127.0.0.1, а иногда от 0:0:0:0:0:0:0:1. Это принуждает к изменению ACL на сервере приложений, что не всегда удобно.</p>

<p>IPv6 отключается после выполнения серии sysctl-команд, которые требуют, чтобы контейнер был запущен в привилегированном режиме, т.е. команда запуска слегка усложняется:</p>

<pre><code>docker run --privileged --rm -it -p 2022:22 smile/nginx /sbin/my_init -- bash -l
</code></pre>

<h3 id="остальные-образы:4df06129fe4804053dfd65ac4e205d9e">Остальные образы</h3>

<p>На основе docker-nginx можно строить более сложные образы, такие как <a href="https://github.com/dddpaul/docker-java7-server">docker-java7-server</a> и  <a href="https://github.com/dddpaul/docker-tomcat7">docker-tomcat7</a>. На основе последнего уже строятся образы для конечных приложений.</p>

        </div>
        
    </div>


</body>
</html>
