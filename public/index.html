<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Dev notes &middot; Dev notes </title>

  
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/poole.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/syntax.css">
  <link rel="stylesheet" href="http://dddpaul.github.io/blog/css/hyde.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://dddpaul.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Dev notes" />

</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Dev notes</h1>
            <p class="lead">
                 Notes about Android, Java, JavaScript, Go and other technical stuff 
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="http://google.com/&#43;PavelDerendyaev1"> Google&#43; </a></li>
            
            <li><a href="index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="/blog/tags/android">android</a> </li>
            
            <li><a href="/blog/tags/angularjs">angularjs</a> </li>
            
            <li><a href="/blog/tags/git">git</a> </li>
            
            <li><a href="/blog/tags/golang">golang</a> </li>
            
            <li><a href="/blog/tags/hugo">hugo</a> </li>
            
            <li><a href="/blog/tags/java">java</a> </li>
            
            <li><a href="/blog/tags/javascript">javascript</a> </li>
            
            <li><a href="/blog/tags/linux">linux</a> </li>
            
        </ul>

        <p>&copy; 2014. All rights reserved. </p>
    </div>
</div>


    <div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/11/14/motion-remote-control/">
        Дистанционное управление Motion с помощью Go
      </a>
    </h1>

    <span class="post-date">2014-11-14</span>

    <p>Цель — сделать удобное управление для сервачка с системой motion detection.  В качестве сервера пригодился классический нетбук Asus Eee PC 701 4-х гигабайтным SSD на борту. На него была установлена Ubuntu 14.04.</p>

<p>Задачи:</p>

<ol>
<li>Собственно, motion detection (для этого был использован <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome">Motion</a>).</li>
<li>Управление настройками Motion через ИК-пульт.</li>
<li>Вывод всех сообщений от Motion и сигналов от пульта на консоль (<em>/dev/tty1</em>).</li>
<li>Минимальное время работы экрана (быстрый переход в энергосберегающйй режим, просыпание по сигналу от пульта).</li>
</ol>

<p><strong>1.</strong> Motion ставится элементарно — <code>apt-get install motion</code>. Важные настройки:</p>

<pre><code># Максимальный fps
framerate 5

# Снимать на максимальном fps только во время движения
webcam_motion on

# Выкрутил в максимум, чтобы избежать срабатывания на включение света

lightswitch 100

# Кол-во кадров с движением, необходимых для генерации события
minimum_motion_frames 3

# Записать кадры до движения
pre_capture 5

# Записать кадры после движения
post_capture 5

# Маска для определения области детекции, легко делается в Gimp'е из снимка с камеры.
# Области, закрашенные черным, игнорируются.
mask_file /path/to/mask.pgm

# Время определения окончания движения (если за 15 секунд после начала движения
# не было никаких поползновений, то считаем, что событие-движение закончилось)
gap 15

# Отключить создание снимков
output_normal off

# Обозначать движение прямоугольником 
locate on

# Запуск скрипта по началу движения (это симлимк, который указывает на реальный скрипт).
# Изменение симлинка осущестляется по команде с пульта (см. п. 2 про конфиг) 
on_event_start &quot;/etc/motion/handlers/on_event_start&quot;
</code></pre>

<p>Для подгонки чувствительности, порога шумов и т.д., нужно использовать setup mode, который активируется при запуске <code>
motion -s</code>.</p>

<p>При этом в mjpeg-трансляции область детекции будет обозначена черным, шумы — серым, а распознанное движение — синим.</p>

<p><strong>2.</strong> Для управления нетбуком был использован <a href="http://www.dx.com/p/multimedia-ir-remote-controller-with-usb-receiver-for-pc-1-cr2025-26368#.VGYO33WUe24">ИК-пульт с USB-приемником</a>. Подобные пульты есть и на aliexpress, и ebay. USB-приемник эмулирует HID-устройство, по сути — обычную клавиатуру.</p>

<p>Для работы с символьными устройствами ввода в Linux есть подсистема <a href="http://en.wikipedia.org/wiki/Evdev">evdev</a>. Потестить распознавание сигналов с пульта можно с помощью утилиты <a href="http://manpages.ubuntu.com/manpages/trusty/man1/evtest.1.html">evtest</a>.</p>

<p>На гитхабе нашелся <a href="https://github.com/gvalkov/golang-evdev">пакет для работы с evdev на Go</a>. Проект больше не поддерживается, так что я отфоркался от <a href="https://github.com/ungerik/golang-evdev">более свежего форка</a> и сделал rebase на ядро Ubuntu 14.04 (3.13.0-39-generic на данный момент):</p>

<pre><code>cd evdev
make ecodes.go
</code></pre>

<p>Поверх golang-evdev я написал <a href="https://github.com/dddpaul/go-evhandler">evhandler</a>. Эта программа запускается от root&rsquo;а и слушает события от input device, указанного в конфиге (как правило, <em>/etc/evhandler.toml</em>).  Мой конфиг:</p>

<pre><code>[params]
    device = &quot;/dev/input/event9&quot;

[actions]
    KEY_STOPCD = &quot;service motion stop&quot;
    KEY_PLAYPAUSE = &quot;service motion start&quot;
    KEY_PAGEUP = &quot;/etc/motion/handlers/handler-select up&quot;
    KEY_PAGEDOWN = &quot;/etc/motion/handlers/handler-select down&quot;
</code></pre>

<p>В разделе <em>actions</em> на кнопки пульта вешаются команды: остановка и запуск motion, и выбор скрипта, который будет запущен при детекции движения. Скрипт <em>handler-select</em> &ldquo;передвигает&rdquo; симлинк <em>on_event_start</em> вверх/вниз, устанавливая, таким образом, реальный скрипт, который будет запускаться. Коллекцию этих скриптов я выложил в <a href="https://github.com/dddpaul/motion-handlers">отдельный проект</a>.</p>

<p>Для чтения и парсинга конфигов я использовал пакет <a href="http://spf13.com/project/viper">Viper</a>. Это очень классная либа от автора <a href="http://gohugo.io/">Hugo</a>, которая умеет:</p>

<ul>
<li>парсить YAML, TOML и JSON;</li>
<li>искать конфиги в разных местах (например, сначала в $HOME, а потом в <em>/etc</em>);</li>
<li>устанавливать значение по-умолчанию и переопределять значения из конфига значениями из CLI.</li>
</ul>

<p><strong>3.</strong> evhandler должен использовать в качестве стандартного вывода <em>/dev/tty1</em>. Сделать это очень просто.</p>

<p>Сначала отключим ввод с <em>/dev/tty1</em> — <code>rm /etc/init/tty1.conf</code>.</p>

<p>И создадим новый upstart job в <em>/etc/init/evhandler.conf</em>:</p>

<pre><code># evhandler - Simple key press listener and handler written in Go

start on runlevel [2345]
stop on runlevel [!2345]

respawn

exec /path/to/go-evhandler &gt; /dev/tty1 2&gt;&amp;1
</code></pre>

<p>Теперь evhandler будет запускаться при загрузке, а также перезапускаться, если его процесс будет прибит. Для ручного запуска — <code>
start evhandler</code>.</p>

<ol>
<li>Управлять включением энергосберегающего режима (а именно, гашением экрана) можно з-мя способами:</li>
<li>указать <code>consoleblank=sss</code> (где sss - секунды) в параметрах ядра (<em>GRUB_CMDLINE_LINUX</em> в <em>/etc/default/grub</em>);</li>
<li>использовать команду <code>setterm -blank mm</code> (где mm - минуты), для включения — <code>setterm -blank poke</code>;</li>
<li>использовать специальные ESC-последовательности в команде <code>echo</code>.</li>
</ol>

<p><code>consoleblank</code> давал странный эффект - после загрузки системы экран становился пустым, но было видно, что подсветка работает. При нажатии клавиш он загорался и полностью погасал через заданное время.</p>

<p><code>setterm</code> через ssh у меня как-то не заработал.</p>

<p>И только управляющая ESC-последовательность для терминала подошла отлично — <code>echo -e '\033[9;X]</code> (где X - минуты).</p>

<p>Для автоматического запуска этой команды создадим job <em>/etc/init/tty1.conf</em>:</p>

<pre><code># tty1 - getty
#
# This service is used to maintain a getty on tty1 from the point the system is
# started until it is shut down again.

start on stopped rc RUNLEVEL=[2345] and (
            not-container or
            container CONTAINER=lxc or
            container CONTAINER=lxc-libvirt)

stop on runlevel [!2345]

# Blank screen after 1 minute timeout
# See http://www.armadeus.com/wiki/index.php?title=FrameBuffer
exec echo -ne &quot;\033[9;1]&quot; &gt; /dev/tty1
</code></pre>

<p>Ссылки:</p>

<ul>
<li><a href="https://github.com/dddpaul/go-evhandler">Evhandler : Simple key press listener and handler written in Go</a></li>
<li><a href="http://spf13.com/project/viper">Viper : Go Configuration Management With Fangs</a></li>
<li><a href="http://superuser.com/a/154388">Change Linux console screen blanking behavior</a></li>
<li><a href="http://raspberrypi.stackexchange.com/questions/10374/wake-console-screen-with-ssh">Wake console screen with SSH</a></li>
<li><a href="http://www.armadeus.com/wiki/index.php?title=FrameBuffer">ArmadeusWiki - Framebuffer</a></li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/10/21/android-memory-leak-badoo/">
        Борьба с утечками памяти в Android (Badoo)
      </a>
    </h1>

    <span class="post-date">2014-10-21</span>

    

<p>На хабре появилась статья <a href="http://habrahabr.ru/company/badoo/blog/240479/">Борьба с утечками памяти в Android. Часть 1</a> от компании Badoo. Т.к. тема созвучна с моими постами из серии <a href="/series/memory-leaks">Memory leaks</a>, то решил вкратце описать их методы.</p>

<p>Суть проблемы — использование android.os.Handler, в который постится анонимный Runnable с помощью метода <a href="http://developer.android.com/reference/android/os/Handler.html#postDelayed(java.lang.Runnable, long">postDelayed</a>. Для демонстрации, Runnable просто меняет какой-либо TextView (т.е. содержит внутри себя ссылку mTextView), и время до выполнения Runnable берется довольно большим. Так вот, если за этот промежуток времени повернуть девайс несколько раз, то старые активити не будут собираться GC, т.к. в Java любой анонимный класс всегда имеет неявную ссылку на внешний класс.</p>

<h3 id="toc_0">Решение с использованием статического класса</h3>

<p>Переделка анонимного класса в статический проблему не решает — Activity сохранен в ссылке mContext из mTextView внутри нашей реализации Runnable.</p>

<h3 id="toc_1">Решение с использованием статического класса и WeakReference</h3>

<p>В реализации Runnable сохраняем ссылку на TextView в WeakReference. Использование WeakReference требует особой аккуратности: такая ссылка в любой момент может обнулиться. Поэтому сначала сохраняем ссылку в локальную переменную и работаем только с последней, проверив ее на null.</p>

<p>Для использования данного подхода нам необходимо:</p>

<ul>
<li>использовать статический внутренний или внешний класс;</li>
<li>использовать WeakReference для всех объектов, на которые мы ссылаемся.</li>
</ul>

<p>Это решает проблему.</p>

<h3 id="toc_2">Очистка всех сообщений в onDestroy</h3>

<p>Добавим в onDestroy вызов метода класса Handler <a href="http://developer.android.com/reference/android/os/Handler.html#removeCallbacksAndMessages(java.lang.Object)">removeCallbacksAndMessages</a>. Он удаляет все сообщения, находящиеся в очереди данного Handler&rsquo;а. Это очень хороший способ защититься от утечки памяти, но во-первых, нужно не забыть это сделать, а во-вторых, в комментах к статье пишут, что вызов onDestroy в общем случае не гарантирован.</p>

<p>Цитата из документации — <a href="http://developer.android.com/training/basics/activity-lifecycle/stopping.html">Stopping and Restarting an Activity</a>:</p>

<blockquote>
<p>When your activity receives a call to the onStop() method, it&rsquo;s no longer visible and should release almost all resources that aren&rsquo;t needed while the user is not using it. Once your activity is stopped, the system might destroy the instance if it needs to recover system memory. In extreme cases, the system might simply kill your app process without calling the activity&rsquo;s final onDestroy() callback, so it&rsquo;s important you use onStop() to release resources that might leak memory.</p>
</blockquote>

<h3 id="toc_3">Решение с использованием WeakHandler</h3>

<p>Команда Badoo написала свой Handler — <a href="github.com/badoo/android-weak-handler">WeakHandler</a>. Это класс, который ведет себя совершенно как Handler, но исключает утечки памяти за счет использования слабых ссылок.</p>

<p>Главная идея — держать жесткую ссылку на сообщения или Runnable до тех пор, пока существует жесткая ссылка на WeakHandler. Как только WeakHandler может быть удален из памяти, все остальное должно быть удалено вместе с ним.</p>

<h3 id="toc_4">Выводы</h3>

<p>Отличная и годная статья :)</p>

<p>Ссылки:</p>

<ul>
<li><a href="http://corner.squareup.com/2013/10/android-main-thread-1.html">A journey on the Android Main Thread - PSVM</a>. Рассказ про про внутренности Main Thread: Loopers, Handlers и т.д.</li>
<li><a href="http://corner.squareup.com/2013/12/android-main-thread-2.html">A journey on the Android Main Thread - Lifecycle bits</a>. Продолжение — про lifecycle и orientation change.</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/10/16/angularjs-directive/">
        Директивы AngularJS
      </a>
    </h1>

    <span class="post-date">2014-10-16</span>

    <p>Статьи:</p>

<ul>
<li><a href="http://statelessprime.blogspot.ru/2013/04/angularjs-directive-overview.html">AngularJS directive: Overview</a>. Очень крутой сборник статей про директивы. Помогает понять, как правильно создать шаблон директивы вручную (через функции compile и link), а также, как навесить watches.</li>
<li><a href="http://www.benlesh.com/2013/08/angularjs-watch-digest-and-apply-oh-my.html">AngularJS: $watch, $digest and $apply</a>. Еще раз об этих базовых функциях AngularJS почитать никогда не вредно.</li>
<li>A Practical Guide to AngularJS Directives - <a href="http://www.sitepoint.com/practical-guide-angularjs-directives/">Part 1</a>, <a href="http://www.sitepoint.com/practical-guide-angularjs-directives-part-two/">Part 2</a>. Подробно про директивы.</li>
<li><a href="http://odetocode.com/blogs/scott/archive/2013/09/11/moving-data-in-an-angularjs-directive.aspx">Moving Data In An AngularJS Directive</a>. Передача данных в директиву.</li>
<li><a href="http://www.undefinednull.com/2014/02/11/mastering-the-scope-of-a-directive-in-angularjs/">Mastering the Scope of the Directives in AngularJS</a>. Очень подробно разжевано про scope в директивах.</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/08/02/orientation-change/">
        Подводные камни смены ориентации в Android
      </a>
    </h1>

    <span class="post-date">2014-08-02</span>

    

<p>После нескольких дней отладки приложения пришел к выводу, что смена ориентации (rotation, orientation change) требует к себе особого внимания. Наконец-то я понял тех разработчиков, которые напрочь запрещают смену ориентации в своем софте. Ведь, не зная некоторых неочевидных нюансов, можно легко получить крах приложения или утечку памяти.</p>

<p>Опишу в порядке возрастания сложности, на какие подводные камни мне пришлось натолкнуться.</p>

<h3 id="toc_0">Beginner&rsquo;s level</h3>

<p>Надо сохранять состояние (state) фрагментов. Не сохранил — потерял, т.к. активити и фрагменты будут пересозданы. Если стейт фрагмента сериализуется в строку, то просто переопределяем метод onSaveInstanceState(). Способ описан как в <a href="http://developer.android.com/guide/components/fragments.html#Lifecycle">официальной документации</a>, так и в множестве других мест.</p>

<h3 id="toc_1">Intermediate</h3>

<p>Не забываем про AsyncTask. Их тоже надо сохранять, ибо иначе при смене ориентации мы его потеряем. Или он что-нибудь обвалит :) Для решения этой проблемы придумана такая отличная штука, как retaining fragments. Всего один вызов setRetainInstance(true) продляет жизнь фрагменту и связанному с ним асинктаску (назовем это длинный стейт).</p>

<p>Тут и начинаются подводные камни. Что если мы хотим в портретном режиме свайпить фрагменты (через ViewPager), а в landscape — просто показать их всех в линеечку (с помощью LinearLayout безо всякого ViewPager)? Запустим приложение в portrait mode, перевернем, и получим &ldquo;IllegalArgumentException: No view found&rdquo;.</p>

<p>Суть в том, что изначальный фрагмент с портретного режима останется и даже сохранит ссылку на ViewPager, которого в landscape layout уже просто нет :) Отсюда вывод - использовать для сохранения длинного стейта нужно headless fragments, т.е. фрагменты без UI. Тогда получается красиво: в &ldquo;обычных&rdquo; фрагментах формочки и кнопочки, а асинктаски — в отдельных, которые ничего про UI не знают.</p>

<p>Остался последний вопрос — как этот headless fragment создать/запустить? В android-samples есть пример <a href="https://android.googlesource.com/platform/development/+/master/samples/ApiDemos/src/com/example/android/apis/app/FragmentRetainInstance.java">FragmentRetainInstance.java</a>, в котором используется способ матрешки - активити запускает parent fragment, parent запускает worker fragment, внутри которого сидит асинктаск.</p>

<p>Вроде хорошая схема, но если вы, не дай бог, возьмете Robolectric и напишите юнит-тест для родительского фрагмента, то получите что-то типа recursive transaction exception. Суть в том, что роболектрик создает тестируемый фрагмент обычным способом (через транзакцию), а внутри запускается новая транзакция (для worker fragment). А так нельзя, это вам не JPA какой-нибудь :)</p>

<p>Итого — держим асинктаски в headless-фрагменте, который запускаем из активити. В целом, это отличная схема на все случаи жизни, а не только для приведенного примера.</p>

<h3 id="toc_2">Veteran</h3>

<p>Копаем в сторону уже вскользь упомянутого multi-pane. Как его сделать правильно на одних фрагментах? Внятно описанный <a href="http://www.vogella.com/tutorials/AndroidFragments/article.html">способ от Ларса Вогеля</a> требует разных активити, а я не хочу плодить сущности.</p>

<p>Используем уже описанный метод с двумя layout&rsquo;ами (ведь мы же за декларативный подход!):</p>

<ul>
<li>1-й layout состоит из одного ViewPager&rsquo;а;</li>
<li>2-й — LinearLayout с двумя фрагментами.</li>
</ul>

<p>В чем прелесть подхода — 2-й layout можно положить в папочку, например, layout-w600dp и он будет автоматически использован, если ширина экрана больше 600dp. Красота!</p>

<p>Оно даже работает и не падает. Правда, появился какой-то странный глюк с <a href="http://github.com/greenrobot/EventBus">EventBus</a>: иногда фрагмент получает два сообщения вместо одного. При более пристальном изучении оказалось наоборот - два одинаковых фрагмента получают одно сообщение. Откуда они берутся? А кто его знает :)</p>

<p>Была убита куча времени в DDMS/VisualVM/MAT, в результате чего появился <a href="https://github.com/dddpaul/android-ViewPagerBug">тестовый проект</a>, также описал симптомы на <a href="http://stackoverflow.com/questions/25033824/dublicate-fragment-allocation-when-using-viewpager-with-different-layouts">StackOverflow</a>. Вкратце, именно при использовании такого варианта multi-pane (когда в одном layout есть ViewPager, а в другом нет), фрагменты при перевороте создаются ДВАЖДЫ. Причем, оба в RESUMED state, поэтому они оба и ловят сообщения по EventBus.</p>

<p>Плюнув, отказался от второго layout&rsquo;а, теперь ViewPager используется везде. Чтобы показать сразу 2 фрагмента, можно использовать разные <a href="http://commonsware.com/blog/2012/08/20/multiple-view-viewpager-options.html">хитрые способы</a>. Они, в общем, несложные, и, в моем случае, способ с переопределением getPageWidth() даже не внес никаких сайд-эффектов. Правда, определение ширины экрана, когда надо показать multi-pane пришлось вынести в код, получилось чуть менее декларативненько.</p>

<h3 id="toc_3">Hardcore</h3>

<p>Плавно переходим к утечкам памяти :)</p>

<p>Очень веселая ситуация, когда после, например, после 10 ротаций эмулятора и нескольких запусков GC в хипе болтаются 11 activities. Решив идти до конца, вооружившись методом исключения и вырезав почти весь код и вьюхи, удалось докопаться до причины. Утекал компонент TextView с опцией <a href="http://stackoverflow.com/questions/22990634/textview-with-id-and-textisselectable-true-causes-leaking-of-the-activity-obje">textIsSelectable=&ldquo;true&rdquo;</a>. Очень порадовало начало топика &ldquo;It took me three days to narrow my problem &hellip;&rdquo; :)</p>

<p>Убрал одну строчку в layout, утечка исчезла, ура. Вернулся в основную ветку, вставил этот коммит, прогнал тест (10 ротаций), получил 10 activities. Уже лучше :)</p>

<p>Оказалось, компонент EditText также замечательно утекает. Причина, вроде бы в том, что он слишком умный (у него по-умолчанию включен спеллчекер). Если отключить, то утечка может пропасть, а может и нет. Прогнал тест на разных эмуляторах, оказалось, что в 4.3 баг починен, уже хорошо! А я все тестил на 4.1.2.</p>

<p>Раз версия 4.3 такая замечательная, может быть, там починена утечка textIsSelectable? А то вдруг понадобится эта опция? Нет, все без изменений. Версия 4.4.2? А вот фиг вам - <a href="https://code.google.com/p/android/issues/detail?id=61671">баг в эмуляторе</a>. Вы не можете повернуть эмулятор с этой версией Андроида :) Тест запустить не удалось.</p>

<p>Фрагменты также могут утекать. В сети полно примеров организации свайпа с ViewPager (это где фрагменты создаются в классе-потомке FragmentPagerAdapter и т.д.) Все замечательно, но не забываем вставлять в onDestroy():</p>

<pre><code>pager.removeAllViews();
pager.setAdapter( null );
</code></pre>

<p>Иначе, каждый раз при rotation старые фрагменты не будут собираться GC. Если у вас приложение с 2-мя фраментами, то после 10 ротаций будет 22, плюс 11 activities. По крайней мере, в 4.1.2. В 4.3 уже можно этим не заморачиваться :)</p>

<h3 id="toc_4">Заключение</h3>

<p>К чему весь этот пост - выложил обновление <a href="https://play.google.com/store/apps/details?id=com.github.dddpaul.netcat">Simple NetCat</a>. Версия 1.4 поддерживает multi-pane на планшетах, содержит меньше багов (скрестил два пальца) и практически не течет по памяти.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/08/01/android-memory-leaks/">
        Android memory leaks
      </a>
    </h1>

    <span class="post-date">2014-08-01</span>

    <p>Articles:</p>

<ul>
<li><p><a href="http://android-developers.blogspot.ru/2009/01/avoiding-memory-leaks.html">Avoiding memory leaks</a>. This great article describes base causes of memory leaks on Android. I quote summary from there:</p>

<ul>
<li>Do not keep long-lived references to a context-activity (a reference to an activity should have the same life cycle as the activity itself)</li>
<li>Try using the context-application instead of a context-activity</li>
<li>Avoid non-static inner classes in an activity if you don&rsquo;t control their life cycle, use a static inner class and make a weak reference to the activity inside. The solution to this issue is to use a static inner class with a WeakReference to the outer class, as done in ViewRoot and its W inner class for instance</li>
<li>A garbage collector is not an insurance against memory leaks</li>
</ul></li>

<li><p><a href="http://www.androiddesignpatterns.com/2013/01/inner-class-handler-memory-leak.html">How to Leak a Context: Handlers &amp; Inner Classes</a>. Be cautious when using inner classes inside activity. The summary:</p>

<ul>
<li>In Java, non-static inner and anonymous classes hold an implicit reference to their outer class. Static inner classes, on the other hand, do not.</li>
<li>Avoid using non-static inner classes in an activity if instances of the inner class outlive the activity&rsquo;s lifecycle.</li>
<li>Instead, prefer static inner classes and hold a weak reference to the activity inside.</li>
</ul></li>

<li><p><a href="http://habrahabr.ru/post/116294/">Отслеживание утечек памяти в Android приложениях</a>. This article gives example of class for tracking memory leaks based on WeakReference.</p></li>
</ul>

<p>StackOverflow discussions mostly:</p>

<ul>
<li><a href="http://geekple.com/blogs/feeds/9AlMn/posts/354891570708736">TextView with id and textIsSelectable=&ldquo;true&rdquo; causes leaking of the Activity object</a>. And corresponding <a href="http://stackoverflow.com/questions/22990634/textview-with-id-and-textisselectable-true-causes-leaking-of-the-activity-obje">Stack Overflow topic</a>. I&rsquo;ve bumped into this issue personally and spent a quite some time too. Rotating emulator and heapdumping mostly :) The point is that TextView with id and android:textIsSelectable=&ldquo;true&rdquo; causes memory leak on Android 4.0.x, 4.1.x, 4.2.x, 4.3.x. Can&rsquo;t check it on 4.4.2 because of <a href="https://code.google.com/p/android/issues/detail?id=61671">emulator bug</a>.</li>
<li><a href="http://stackoverflow.com/questions/18348049/android-edittext-memory-leak">Android EditText Memory Leak</a>, <a href="http://stackoverflow.com/questions/8497965/why-does-edittext-retain-its-activitys-context-in-ice-cream-sandwich">Why does EditText retain its Activity&rsquo;s Context in Ice Cream Sandwich</a>, <a href="http://stackoverflow.com/questions/14069501/edittext-causing-memory-leak">EditText causing memory leak</a>. The main theme of this topics is that EditText leaks when spellchecker suggestions are used. You can turn it off but it can help or maybe not. EditText is leaking on Android 4.0.x, 4.1.x, 4.2.x. Thanks god, seems like it&rsquo;s fixed in Android 4.3, API 18 (checked on Nexus 7 2013 emulator). Although <a href="https://code.google.com/p/android/issues/detail?id=60930">corresponding issue</a> is still open.</li>
<li><a href="http://stackoverflow.com/a/18414294">Fragments are not being released from memory</a>. A valuable advice - use weak references to point to any object that references its context outside of your Activity. I&rsquo;m not sure is it a proper approach to weak referencing ViewPager, but for some more &ldquo;distant&rdquo; object like <a href="http://www.michenux.net/android-asynctask-in-fragment-best-pratices-725.html">AsyncTask</a> it might be reasonable.</li>
</ul>

<p>Videos:</p>

<ul>
<li><a href="http://www.youtube.com/watch?v=_CruQY55HOk"> Google I/O 2011: Memory management for Android Apps </a>. Presentation by <a href="http://dubroy.com">Patrick Dubroy</a>.</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/07/30/multi-pane/">
        Multi-pane layout for tablets
      </a>
    </h1>

    <span class="post-date">2014-07-30</span>

    <p>Some articles:</p>

<ul>
<li><a href="http://commonsware.com/blog/2012/08/20/multiple-view-viewpager-options.html">Multiple-View ViewPager Options</a>. It&rsquo;s a brilliant set of methods to display several fragments simultaneously using ViewPager. I&rsquo;ve personally used first method (overriding getPageWidth() in PagerAdapter) - it works for me.</li>
<li><a href="http://shashikawlp.wordpress.com/2012/12/13/android-viewpager-with-multiple-views/">Android ViewPager with Multiple Views</a>. Looks like third method from previous article.</li>
</ul>

<p>And StackOverflow discussions:</p>

<ul>
<li><a href="http://stackoverflow.com/questions/9468581/can-viewpager-have-multiple-views-in-per-page">Can ViewPager have multiple views in per page?</a>. There are links to CommonsWare article and description of method used for some Dutch newspaper app. Looks nice but it display one full page and part of another - it&rsquo;s not what I need now.</li>
<li><a href="http://stackoverflow.com/questions/23149850/viewpager-with-different-adapters-for-portrait-and-landscape">ViewPager with different adapters for portrait and landscape</a>. Dude wants to show A,B,C fragments in portrait mode and A,C only in landscape. Not my case but interesting.</li>
<li><a href="http://stackoverflow.com/questions/6465680/how-to-determine-the-screen-width-in-terms-of-dp-or-dip-at-runtime-in-android">How to determine the screen width in terms of dp or dip at runtime in Android?</a>. Describe how to calculate screen size in &ldquo;density-independent pixels&rdquo;. It&rsquo;s useful for decide when which layout to use programmatically.</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/07/29/headless-fragments/">
        Retaining state with headless fragments
      </a>
    </h1>

    <span class="post-date">2014-07-29</span>

    <p>Some articles:</p>

<ul>
<li>Official <a href="http://developer.android.com/guide/components/fragments.html">Fragments guide</a>. Has some clues for headless fragments (see &ldquo;Adding a fragment without a UI&rdquo;).</li>
<li>Superb <a href="http://www.vogella.com/tutorials/AndroidFragments/article.html">multi-pane fragments tutorial</a> from Lars Vogel. Contains some tips for <a href="http://www.vogella.com/tutorials/AndroidFragments/article.html#headlessfragments">headless fragments</a>.</li>
<li><a href="http://techbandhu.wordpress.com/2013/07/02/android-headless-fragment/">Android best tip to work with fragments and orientation change</a>. More detailed headless fragments technique description.</li>
<li>Headless fragment example - <a href="https://android.googlesource.com/platform/development/+/master/samples/ApiDemos/src/com/example/android/apis/app/FragmentRetainInstance.java">FragmentRetainInstance.java</a>. In this code headless fragment is created from other fragment. In my case it&rsquo;s inappropriate because of Robolectric testing (recursive fragment transactions).</li>
<li><a href="http://www.intertech.com/Blog/saving-and-retrieving-android-instance-state-part-2/">Saving (And Retrieving) Android Instance State – Part 2</a>. Details about retained fragments. Neat retained fragment lifecycle.</li>
<li><a href="http://www.androiddesignpatterns.com/2013/04/retaining-objects-across-config-changes.html">Handling Configuration Changes with Fragments</a>. Main advice - Manage the Object Inside a Retained Fragment.</li>
<li><a href="http://ideaventure.blogspot.com.au/2014/01/android-activityfragment-life-cycle.html">Android Activity/Fragment life cycle analysis</a>. Full logging of all lifecycle method calls in different situations.</li>
</ul>

<p>And StackOverflow discussions:</p>

<ul>
<li><a href="http://stackoverflow.com/questions/11591302/unable-to-use-fragment-setretaininstance-as-a-replacement-for-activity-onretai">Unable to use Fragment.setRetainInstance() as a replacement for Activity.onRetainNonConfigurationInstance()</a>. How to preserve fragments with WebViews and AsyncTasks. One of the answers is to override Fragment.onDestroy() and save asynctasks to Application object.</li>
<li><a href="http://stackoverflow.com/questions/12640316/further-understanding-setretaininstancetrue">Further understanding setRetainInstance(true)</a>. Retained fragment lifecycle logs.</li>
<li><a href="http://stackoverflow.com/questions/8417885/android-fragments-retaining-an-asynctask-during-screen-rotation-or-configuratio">Android Fragments. Retaining an AsyncTask during screen rotation or configuration change</a>. Retained fragment with inner asynctask example and much more. AsyncTask has reference to fragment - it&rsquo;s interesting.</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://dddpaul.github.io/blog/2014/07/28/oldest/">
        First note
      </a>
    </h1>

    <span class="post-date">2014-07-28</span>

    <p>This blog is based on <a href="http://hugo.spf13.com/">Hugo</a> - static site generator written on Go. GitHub interaction is organized with use of <a href="http://hugo.spf13.com/tutorials/github_pages_blog">Hosting on GitHub Pages</a> tutorial. See &ldquo;Configure git Workflow&rdquo; section specifically.</p>

<p>And for all of the git 1.7.x (and older) users - you can grab git-subtree from contrib dirertory of <a href="https://github.com/git/git">Git repo</a>. I&rsquo;ve used git-subtree from latest 1.8.x. It&rsquo;s just a shell script, run make, chmod +x and copy it to /usr/lib/git-core.</p>

  </div>
  
</div>


  </body>
</html>
